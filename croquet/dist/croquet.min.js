/**
 * Copyright Croquet Corporation 2020
 * Bundle of @croquet/croquet
 * Generated: 2020-04-29
 * Version: 0.2.7
 */

"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var e=t(require("@babel/runtime/regenerator")),n=t(require("@babel/runtime/helpers/slicedToArray")),r=t(require("@babel/runtime/helpers/toConsumableArray")),o=t(require("@babel/runtime/helpers/typeof")),i=t(require("@babel/runtime/helpers/asyncToGenerator")),a=t(require("@babel/runtime/helpers/defineProperty")),s=t(require("toastify-js")),c=t(require("seedrandom/seedrandom")),u=t(require("@babel/runtime/helpers/classCallCheck")),l=t(require("@babel/runtime/helpers/createClass")),h=t(require("fast-json-stable-stringify")),f=t(require("@babel/runtime/helpers/get")),d=t(require("@babel/runtime/helpers/inherits")),v=t(require("@babel/runtime/helpers/possibleConstructorReturn")),p=t(require("@babel/runtime/helpers/getPrototypeOf")),y=t(require("fastpriorityqueue")),m=t(require("@babel/runtime/helpers/toArray")),g=t(require("@babel/runtime/helpers/construct"));const b="production",w="0.2.7";if(void 0===window.TextEncoder){window.TextEncoder=function(){},TextEncoder.prototype.encode=function(t){for(var e=t.length,n=-1,r="undefined"==typeof Uint8Array?new Array(1.5*e):new Uint8Array(3*e),o=0,i=0,a=0;a!==e;){if(o=t.charCodeAt(a),a+=1,o>=55296&&o<=56319){if(a===e){r[n+=1]=239,r[n+=1]=191,r[n+=1]=189;break}if(!((i=t.charCodeAt(a))>=56320&&i<=57343)){r[n+=1]=239,r[n+=1]=191,r[n+=1]=189;continue}if(a+=1,(o=1024*(o-55296)+i-56320+65536)>65535){r[n+=1]=240|o>>>18,r[n+=1]=128|o>>>12&63,r[n+=1]=128|o>>>6&63,r[n+=1]=128|63&o;continue}}o<=127?r[n+=1]=0|o:o<=2047?(r[n+=1]=192|o>>>6,r[n+=1]=128|63&o):(r[n+=1]=224|o>>>12,r[n+=1]=128|o>>>6&63,r[n+=1]=128|63&o)}return"undefined"!=typeof Uint8Array?r.subarray(0,n+1):(r.length=n+1,r)},TextEncoder.prototype.toString=function(){return"[object TextEncoder]"};try{Object.defineProperty(TextEncoder.prototype,"encoding",{get:function(){if(TextEncoder.prototype.isPrototypeOf(this))return"utf-8";throw TypeError("Illegal invocation")}})}catch(t){TextEncoder.prototype.encoding="utf-8"}"undefined"!=typeof Symbol&&(TextEncoder.prototype[Symbol.toStringTag]="TextEncoder")}var k;!function(){function t(t){this.mode=n.MODE_8BIT_BYTE,this.data=t,this.parsedData=[];for(var e=0,r=this.data.length;e<r;e++){var o=[],i=this.data.charCodeAt(e);i>65536?(o[0]=240|(1835008&i)>>>18,o[1]=128|(258048&i)>>>12,o[2]=128|(4032&i)>>>6,o[3]=128|63&i):i>2048?(o[0]=224|(61440&i)>>>12,o[1]=128|(4032&i)>>>6,o[2]=128|63&i):i>128?(o[0]=192|(1984&i)>>>6,o[1]=128|63&i):o[0]=i,this.parsedData.push(o)}this.parsedData=Array.prototype.concat.apply([],this.parsedData),this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function e(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}t.prototype={getLength:function(t){return this.parsedData.length},write:function(t){for(var e=0,n=this.parsedData.length;e<n;e++)t.put(this.parsedData[e],8)}},e.prototype={addData:function(e){var n=new t(e);this.dataList.push(n),this.dataCache=null},isDark:function(t,e){if(t<0||this.moduleCount<=t||e<0||this.moduleCount<=e)throw new Error(t+","+e);return this.modules[t][e]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(t,n){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var o=0;o<this.moduleCount;o++)this.modules[r][o]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(t,n),this.typeNumber>=7&&this.setupTypeNumber(t),null==this.dataCache&&(this.dataCache=e.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,n)},setupPositionProbePattern:function(t,e){for(var n=-1;n<=7;n++)if(!(t+n<=-1||this.moduleCount<=t+n))for(var r=-1;r<=7;r++)e+r<=-1||this.moduleCount<=e+r||(this.modules[t+n][e+r]=0<=n&&n<=6&&(0==r||6==r)||0<=r&&r<=6&&(0==n||6==n)||2<=n&&n<=4&&2<=r&&r<=4)},getBestMaskPattern:function(){for(var t=0,e=0,n=0;n<8;n++){this.makeImpl(!0,n);var r=f.getLostPoint(this);(0==n||t>r)&&(t=r,e=n)}return e},createMovieClip:function(t,e,n){var r=t.createEmptyMovieClip(e,n);this.make();for(var o=0;o<this.modules.length;o++)for(var i=1*o,a=0;a<this.modules[o].length;a++){var s=1*a;this.modules[o][a]&&(r.beginFill(0,100),r.moveTo(s,i),r.lineTo(s+1,i),r.lineTo(s+1,i+1),r.lineTo(s,i+1),r.endFill())}return r},setupTimingPattern:function(){for(var t=8;t<this.moduleCount-8;t++)null==this.modules[t][6]&&(this.modules[t][6]=t%2==0);for(var e=8;e<this.moduleCount-8;e++)null==this.modules[6][e]&&(this.modules[6][e]=e%2==0)},setupPositionAdjustPattern:function(){for(var t=f.getPatternPosition(this.typeNumber),e=0;e<t.length;e++)for(var n=0;n<t.length;n++){var r=t[e],o=t[n];if(null==this.modules[r][o])for(var i=-2;i<=2;i++)for(var a=-2;a<=2;a++)this.modules[r+i][o+a]=-2==i||2==i||-2==a||2==a||0==i&&0==a}},setupTypeNumber:function(t){for(var e=f.getBCHTypeNumber(this.typeNumber),n=0;n<18;n++){var r=!t&&1==(e>>n&1);this.modules[Math.floor(n/3)][n%3+this.moduleCount-8-3]=r}for(n=0;n<18;n++){r=!t&&1==(e>>n&1);this.modules[n%3+this.moduleCount-8-3][Math.floor(n/3)]=r}},setupTypeInfo:function(t,e){for(var n=this.errorCorrectLevel<<3|e,r=f.getBCHTypeInfo(n),o=0;o<15;o++){var i=!t&&1==(r>>o&1);o<6?this.modules[o][8]=i:o<8?this.modules[o+1][8]=i:this.modules[this.moduleCount-15+o][8]=i}for(o=0;o<15;o++){i=!t&&1==(r>>o&1);o<8?this.modules[8][this.moduleCount-o-1]=i:o<9?this.modules[8][15-o-1+1]=i:this.modules[8][15-o-1]=i}this.modules[this.moduleCount-8][8]=!t},mapData:function(t,e){for(var n=-1,r=this.moduleCount-1,o=7,i=0,a=this.moduleCount-1;a>0;a-=2)for(6==a&&a--;;){for(var s=0;s<2;s++)if(null==this.modules[r][a-s]){var c=!1;i<t.length&&(c=1==(t[i]>>>o&1)),f.getMask(e,r,a-s)&&(c=!c),this.modules[r][a-s]=c,-1==--o&&(i++,o=7)}if((r+=n)<0||this.moduleCount<=r){r-=n,n=-n;break}}}},e.PAD0=236,e.PAD1=17,e.createData=function(t,n,r){for(var o=y.getRSBlocks(t,n),i=new m,a=0;a<r.length;a++){var s=r[a];i.put(s.mode,4),i.put(s.getLength(),f.getLengthInBits(s.mode,t)),s.write(i)}var c=0;for(a=0;a<o.length;a++)c+=o[a].dataCount;if(i.getLengthInBits()>8*c)throw new Error("code length overflow. ("+i.getLengthInBits()+">"+8*c+")");for(i.getLengthInBits()+4<=8*c&&i.put(0,4);i.getLengthInBits()%8!=0;)i.putBit(!1);for(;!(i.getLengthInBits()>=8*c||(i.put(e.PAD0,8),i.getLengthInBits()>=8*c));)i.put(e.PAD1,8);return e.createBytes(i,o)},e.createBytes=function(t,e){for(var n=0,r=0,o=0,i=new Array(e.length),a=new Array(e.length),s=0;s<e.length;s++){var c=e[s].dataCount,u=e[s].totalCount-c;r=Math.max(r,c),o=Math.max(o,u),i[s]=new Array(c);for(var l=0;l<i[s].length;l++)i[s][l]=255&t.buffer[l+n];n+=c;var h=f.getErrorCorrectPolynomial(u),d=new p(i[s],h.getLength()-1).mod(h);a[s]=new Array(h.getLength()-1);for(l=0;l<a[s].length;l++){var v=l+d.getLength()-a[s].length;a[s][l]=v>=0?d.get(v):0}}var y=0;for(l=0;l<e.length;l++)y+=e[l].totalCount;var m=new Array(y),g=0;for(l=0;l<r;l++)for(s=0;s<e.length;s++)l<i[s].length&&(m[g++]=i[s][l]);for(l=0;l<o;l++)for(s=0;s<e.length;s++)l<a[s].length&&(m[g++]=a[s][l]);return m};for(var n={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},r={L:1,M:0,Q:3,H:2},o=0,i=1,a=2,s=3,c=4,u=5,l=6,h=7,f={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(t){for(var e=t<<10;f.getBCHDigit(e)-f.getBCHDigit(f.G15)>=0;)e^=f.G15<<f.getBCHDigit(e)-f.getBCHDigit(f.G15);return(t<<10|e)^f.G15_MASK},getBCHTypeNumber:function(t){for(var e=t<<12;f.getBCHDigit(e)-f.getBCHDigit(f.G18)>=0;)e^=f.G18<<f.getBCHDigit(e)-f.getBCHDigit(f.G18);return t<<12|e},getBCHDigit:function(t){for(var e=0;0!=t;)e++,t>>>=1;return e},getPatternPosition:function(t){return f.PATTERN_POSITION_TABLE[t-1]},getMask:function(t,e,n){switch(t){case o:return(e+n)%2==0;case i:return e%2==0;case a:return n%3==0;case s:return(e+n)%3==0;case c:return(Math.floor(e/2)+Math.floor(n/3))%2==0;case u:return e*n%2+e*n%3==0;case l:return(e*n%2+e*n%3)%2==0;case h:return(e*n%3+(e+n)%2)%2==0;default:throw new Error("bad maskPattern:"+t)}},getErrorCorrectPolynomial:function(t){for(var e=new p([1],0),n=0;n<t;n++)e=e.multiply(new p([1,d.gexp(n)],0));return e},getLengthInBits:function(t,e){if(1<=e&&e<10)switch(t){case n.MODE_NUMBER:return 10;case n.MODE_ALPHA_NUM:return 9;case n.MODE_8BIT_BYTE:case n.MODE_KANJI:return 8;default:throw new Error("mode:"+t)}else if(e<27)switch(t){case n.MODE_NUMBER:return 12;case n.MODE_ALPHA_NUM:return 11;case n.MODE_8BIT_BYTE:return 16;case n.MODE_KANJI:return 10;default:throw new Error("mode:"+t)}else{if(!(e<41))throw new Error("type:"+e);switch(t){case n.MODE_NUMBER:return 14;case n.MODE_ALPHA_NUM:return 13;case n.MODE_8BIT_BYTE:return 16;case n.MODE_KANJI:return 12;default:throw new Error("mode:"+t)}}},getLostPoint:function(t){for(var e=t.getModuleCount(),n=0,r=0;r<e;r++)for(var o=0;o<e;o++){for(var i=0,a=t.isDark(r,o),s=-1;s<=1;s++)if(!(r+s<0||e<=r+s))for(var c=-1;c<=1;c++)o+c<0||e<=o+c||0==s&&0==c||a==t.isDark(r+s,o+c)&&i++;i>5&&(n+=3+i-5)}for(r=0;r<e-1;r++)for(o=0;o<e-1;o++){var u=0;t.isDark(r,o)&&u++,t.isDark(r+1,o)&&u++,t.isDark(r,o+1)&&u++,t.isDark(r+1,o+1)&&u++,0!=u&&4!=u||(n+=3)}for(r=0;r<e;r++)for(o=0;o<e-6;o++)t.isDark(r,o)&&!t.isDark(r,o+1)&&t.isDark(r,o+2)&&t.isDark(r,o+3)&&t.isDark(r,o+4)&&!t.isDark(r,o+5)&&t.isDark(r,o+6)&&(n+=40);for(o=0;o<e;o++)for(r=0;r<e-6;r++)t.isDark(r,o)&&!t.isDark(r+1,o)&&t.isDark(r+2,o)&&t.isDark(r+3,o)&&t.isDark(r+4,o)&&!t.isDark(r+5,o)&&t.isDark(r+6,o)&&(n+=40);var l=0;for(o=0;o<e;o++)for(r=0;r<e;r++)t.isDark(r,o)&&l++;return n+=10*(Math.abs(100*l/e/e-50)/5)}},d={glog:function(t){if(t<1)throw new Error("glog("+t+")");return d.LOG_TABLE[t]},gexp:function(t){for(;t<0;)t+=255;for(;t>=256;)t-=255;return d.EXP_TABLE[t]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)},v=0;v<8;v++)d.EXP_TABLE[v]=1<<v;for(v=8;v<256;v++)d.EXP_TABLE[v]=d.EXP_TABLE[v-4]^d.EXP_TABLE[v-5]^d.EXP_TABLE[v-6]^d.EXP_TABLE[v-8];for(v=0;v<255;v++)d.LOG_TABLE[d.EXP_TABLE[v]]=v;function p(t,e){if(null==t.length)throw new Error(t.length+"/"+e);for(var n=0;n<t.length&&0==t[n];)n++;this.num=new Array(t.length-n+e);for(var r=0;r<t.length-n;r++)this.num[r]=t[r+n]}function y(t,e){this.totalCount=t,this.dataCount=e}function m(){this.buffer=[],this.length=0}p.prototype={get:function(t){return this.num[t]},getLength:function(){return this.num.length},multiply:function(t){for(var e=new Array(this.getLength()+t.getLength()-1),n=0;n<this.getLength();n++)for(var r=0;r<t.getLength();r++)e[n+r]^=d.gexp(d.glog(this.get(n))+d.glog(t.get(r)));return new p(e,0)},mod:function(t){if(this.getLength()-t.getLength()<0)return this;for(var e=d.glog(this.get(0))-d.glog(t.get(0)),n=new Array(this.getLength()),r=0;r<this.getLength();r++)n[r]=this.get(r);for(r=0;r<t.getLength();r++)n[r]^=d.gexp(d.glog(t.get(r))+e);return new p(n,0).mod(t)}},y.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],y.getRSBlocks=function(t,e){var n=y.getRsBlockTable(t,e);if(null==n)throw new Error("bad rs block @ typeNumber:"+t+"/errorCorrectLevel:"+e);for(var r=n.length/3,o=[],i=0;i<r;i++)for(var a=n[3*i+0],s=n[3*i+1],c=n[3*i+2],u=0;u<a;u++)o.push(new y(s,c));return o},y.getRsBlockTable=function(t,e){switch(e){case r.L:return y.RS_BLOCK_TABLE[4*(t-1)+0];case r.M:return y.RS_BLOCK_TABLE[4*(t-1)+1];case r.Q:return y.RS_BLOCK_TABLE[4*(t-1)+2];case r.H:return y.RS_BLOCK_TABLE[4*(t-1)+3];default:return}},m.prototype={get:function(t){var e=Math.floor(t/8);return 1==(this.buffer[e]>>>7-t%8&1)},put:function(t,e){for(var n=0;n<e;n++)this.putBit(1==(t>>>e-n-1&1))},getLengthInBits:function(){return this.length},putBit:function(t){var e=Math.floor(this.length/8);this.buffer.length<=e&&this.buffer.push(0),t&&(this.buffer[e]|=128>>>this.length%8),this.length++}};var g=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]],b=function(){var t=function(t,e){this._bIsPainted=!1,this._htOption=e,this._elCanvas=document.createElement("canvas"),this._elCanvas.width=e.width,this._elCanvas.height=e.height,t.appendChild(this._elCanvas),this._el=t,this._oContext=this._elCanvas.getContext("2d"),this._bIsPainted=!1,this._bSupportDataURI=null};return t.prototype.draw=function(t){var e=this._oContext,n=this._htOption,r=t.getModuleCount(),o=n.width/r,i=n.height/r,a=Math.round(o),s=Math.round(i);this.clear();for(var c=0;c<r;c++)for(var u=0;u<r;u++){var l=t.isDark(c,u),h=u*o,f=c*i;e.strokeStyle=l?n.colorDark:n.colorLight,e.lineWidth=1,e.fillStyle=l?n.colorDark:n.colorLight,e.fillRect(h,f,o,i),e.strokeRect(Math.floor(h)+.5,Math.floor(f)+.5,a,s),e.strokeRect(Math.ceil(h)-.5,Math.ceil(f)-.5,a,s)}this._bIsPainted=!0},t.prototype.isPainted=function(){return this._bIsPainted},t.prototype.clear=function(){this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height),this._bIsPainted=!1},t.prototype.round=function(t){return t?Math.floor(1e3*t)/1e3:t},t}();function w(t,e){for(var n=1,o=function(t){var e=encodeURI(t).toString().replace(/\%[0-9a-fA-F]{2}/g,"a");return e.length+(e.length!=t?3:0)}(t),i=0,a=g.length;i<=a;i++){var s=0;switch(e){case r.L:s=g[i][0];break;case r.M:s=g[i][1];break;case r.Q:s=g[i][2];break;case r.H:s=g[i][3]}if(o<=s)break;n++}if(n>g.length)throw new Error("Too long data");return n}(k=function(t,e){if(this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:r.H},"string"==typeof e&&(e={text:e}),e)for(var n in e)this._htOption[n]=e[n];"string"==typeof t&&(t=document.getElementById(t)),this._htOption.useSVG&&(b=svgDrawer),this._el=t,this._oQRCode=null,this._oDrawing=new b(this._el,this._htOption),this._htOption.text&&this.makeCode(this._htOption.text)}).prototype.makeCode=function(t){this._oQRCode=new e(w(t,this._htOption.correctLevel),this._htOption.correctLevel),this._oQRCode.addData(t),this._oQRCode.make(),this._oDrawing.draw(this._oQRCode)},k.prototype.clear=function(){this._oDrawing.clear()},k.prototype.getCanvas=function(){for(var t=0;t<this._el.children.length;t++){var e=this._el.children[t];if("CANVAS"===e.tagName)return e}return null},k.CorrectLevel=r}();var S=k;function x(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return C(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return C(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,i=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function C(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function E(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return O(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return O(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,i=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function O(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}"object"===("undefined"==typeof module?"undefined":o(module))&&module.bundle&&module.bundle.modules&&module.bundle.cache&&function(){for(var t=module.bundle,e={},o={},i={},a=0,s=Object.entries(t.modules);a<s.length;a++){var c=n(s[a],2),u=c[0],l=c[1],h=""+t.modules[u][0],f=o[h];f?i[u]=f:o[h]=u;for(var d=0,v=Object.entries(l[1]);d<v.length;d++){var p=n(v[d],2),y=p[0],m=p[1];(e[m]||(e[m]=new Set)).add(y)}}for(var g=function(t){return e[t]?"".concat(r(e[t]).sort().join('" and "')):"top-level"},b={},w=[],k=0,S=Object.entries(t.modules);k<S.length;k++)for(var C=n(S[k],2),E=C[0],O=C[1],_=0,T=Object.entries(O[1]);_<T.length;_++){var A=n(T[_],2),M=A[0],I=A[1],j=i[I];j&&(t.cache[I]?b[j]=I:(O[1][M]=j,delete t.modules[I],w.push('"'.concat(M,'" in "').concat(g(E),'" (').concat(E,")"))))}for(var q=0,N=Object.entries(t.modules);q<N.length;q++)for(var P=n(N[q],2),D=P[0],R=P[1],L=0,B=Object.entries(R[1]);L<B.length;L++){var F=n(B[L],2),U=F[0],H=F[1],$=b[H];$&&(t.cache[H]?console.warn('Could not deduplicate import "'.concat(U,'" in "').concat(g(D),'" (to fix, import "').concat(g(module.id),'" earlier)')):(R[1][U]=$,delete t.modules[H],w.push('"'.concat(U,'" in "').concat(g(D),'" (').concat(D,")"))))}var V,J=x(w.sort());try{for(J.s();!(V=J.n()).done;){var W=V.value;console.log("Deduplicated import",W)}}catch(t){J.e(t)}finally{J.f()}}();var _=window.location.hostname.endsWith("croquet.studio"),T="",A="";function M(t,e){if(e){var n,r=E(e.split("&"));try{for(r.s();!(n=r.n()).done;){var o=n.value.split("="),i=o[0],a=!0;if(o.length>1&&(a=decodeURIComponent(o.slice(1).join("="))).match(/^(true|false|null|[0-9.]*|["[{].*)$/))try{a=JSON.parse(a)}catch(t){"["===a[0]&&(a=a.slice(1,-1).split(","))}t[i]=a}}catch(t){r.e(t)}finally{r.f()}}}var I=new(function(){function t(){u(this,t),this.getSession(),M(this,window.location.search.slice(1)),M(this,_?window.location.hash.slice(1):A),window.location.pathname.indexOf("/ar.html")>=0&&(this.ar=!0)}return l(t,[{key:"has",value:function(t,e,n){"boolean"!=typeof n&&(n=this.isHost(n));var r=this[t];if("string"!=typeof r)return n;var o=r.split(",");return!0===n&&(e="no".concat(e)),e.endsWith("s")&&(e=e.slice(0,-1)),o.includes(e)||o.includes("".concat(e,"s"))?!n:n}},{key:"getSession",value:function(){if(_){var t=window.location.pathname.match(/^\/([^/]+)\/(.*)$/);if(t)return T=t[1],t[2]}else{var e=window.location.hash.match(/^#([^&]+)&?(.*)$/);if(e)return e[1].includes("=")?(A="".concat(e[1],"&").concat(e[2]),""):(A=e[2],e[1])}return"string"==typeof this.session?(A=window.location.hash.slice(1),this.session):""}},{key:"setSession",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];null==_&&this.getSession();var n=window.location,r=n.search,o=n.hash,i=_?"/".concat(T,"/").concat(t).concat(r).concat(o):"#".concat(t).concat(A?"&"+A:"");e?window.history.replaceState({},"",i):window.history.pushState({},"",i)}},{key:"isHost",value:function(t){var e=window.location.hostname;return e===t||"localhost"===t&&(!!e.endsWith(".ngrok.io")||["127.0.0.1","::1"].includes(e))}},{key:"isLocalhost",value:function(){return this.isHost("localhost")}}]),t}());function j(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return q(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return q(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,i=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function q(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var N=Date.now();"undefined"==typeof performance&&(window.performance={now:function(){return Date.now()-N}});var P=["simulate","update","render","snapshot"],D={total:"black",update:"blue",render:"magenta",simulate:"yellow",snapshot:"green",backlog:"red",network:"lightgray"},R=null,L=null,B=null,F=null;function U(t){for(R=t;t.firstChild;)t.removeChild(t.firstChild);t.style.background="#faf0dc",(L=document.createElement("div")).id="text_stats",L.style.padding=5,L.style.background="rgba(255,255,255,0.2)",L.style.fontFamily="sans-serif",t.appendChild(L),t.title=Object.entries(D).map((function(t){var e=n(t,2),r=e[0],o=e[1];return"".concat(o,": ").concat(r)})).join("\n"),(B=document.createElement("canvas")).width=Math.min(125,window.innerWidth)*window.devicePixelRatio,B.height=125*window.devicePixelRatio,B.style.width="100%",t.appendChild(B),(F=B.getContext("2d")).scale(window.devicePixelRatio,window.devicePixelRatio)}var H=[],$=0,V=!1,J=W(0);function W(t){return{start:t,total:0,items:{},users:0,backlog:0,network:0,latency:0,activity:1e3,connected:V}}function z(t){for(J.total=t-J.start,H.push(J);H.length>Math.min(120,window.innerWidth);)H.shift();if(R&&"none"!==window.getComputedStyle(R).display){var e=H.slice(1).filter((function(t){return t.total})),n=e.map((function(t){return t.total})).reduce((function(t,e){return t+e}),0)/e.length;Math.max.apply(Math,r(e.map((function(t){return Math.max(t.backlog,t.network)}))));$=1e3,L.parentElement||(console.warn("who broke the stats div and canvas?"),R.appendChild(L),R.appendChild(B)),L.innerText="".concat(J.users," users, ").concat(Math.round(1e3/n)," fps, ")+(J.backlog<100&&J.activity<1e3?"latency: ".concat(J.latency," ms"):"backlog: ".concat(J.backlog<100?"0.0":(J.backlog/1e3).toFixed(1)," s")),F.clearRect(0,0,B.width,B.height);for(var o=function(t){return 20*(1-t/(1e3/60))+60},i=function(t){return o(t/$*-2*(1e3/60))+5},a=0;a<H.length;a++){var s=H[a],c=a+.5,u=o(0);F.beginPath(),F.moveTo(c,u),F.lineTo(c,o(s.total)),F.strokeStyle=D[s.connected?"total":"network"],F.stroke(),F.beginPath(),F.moveTo(c,u),u=o(s.total);var l,h=0,f=j(P);try{for(f.s();!(l=f.n()).done;){var d=l.value;s.items[d]&&(h+=s.items[d],u=o(h),F.lineTo(c,u),F.strokeStyle=D[d],F.stroke(),F.beginPath(),F.moveTo(c,u))}}catch(t){f.e(t)}finally{f.f()}s.network&&(F.beginPath(),F.moveTo(c,i(0)),F.lineTo(c,i(s.network)),F.strokeStyle=D.network,F.stroke())}F.strokeStyle="rgba(255, 255, 255, 0.2)";for(var v=0;v<60;v+=1e3/60)F.moveTo(0,o(v)),F.lineTo(120,o(v)),F.stroke()}}var G=[],K={animationFrame:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};z(t),J=W(t);for(var r=0,o=Object.entries(e);r<o.length;r++){var i=n(o[r],2),a=i[0],s=i[1];this[a](s)}},begin:function(t){var e=performance.now();J.items[t]=(J.items[t]||0)-e;var n=G[G.length-1];return n&&(J.items[n]+=e),G.push(t),e},end:function(t){var e=performance.now();if(J.items[t]+=e,G.pop()!==t)throw Error("Unmatched stats calls for "+t);var n=G[G.length-1];return n&&(J.items[n]-=e),e},backlog:function(t){J.backlog=Math.max(t,J.backlog)},network:function(t){J.network=t},starvation:function(t){J.network=t},latency:function(t){J.latency=t},activity:function(t){J.activity=t},users:function(t){J.users=t},connected:function(t){J.connected=V=t}};function Q(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function Y(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Q(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Q(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var X,Z,tt,et="ontouchstart"in document.documentElement,nt=et?20:12,rt=et?0:15;X="\n        #croquet_dock { position: absolute; z-index: 2; border: 3px solid white; bottom: 6px; left: 6px; width: 84px; height: 36px; box-sizing: border-box; background: white; opacity: 0.4; transition: all ".concat(.3,"s ease; }\n        #croquet_dock.active { opacity: 0.95; border-radius: 12px; }\n        #croquet_dock_bar { position: absolute; border: 3px solid white; width: 100%; height: 30px; box-sizing: border-box; background: white; }\n\n        #croquet_badge { position: absolute; width: 72px; height: 24px; top: 50%; transform: translate(0px, -50%); cursor: none; }\n        #croquet_dock.active #croquet_badge { left: 2%; }\n\n        .croquet_dock_button { position: absolute; width: ").concat(nt,"%; height: 90%; top: 50%; transform: translate(0px, -50%); border-radius: 20%; }\n        .croquet_dock_button:focus { outline: 0; }\n        .croquet_dock_button canvas { position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; }\n        #croquet_dock:not(.active) .croquet_dock_button { display: none; }\n        #croquet_dock_left { right: ").concat(2+rt+nt+2,"% }\n        #croquet_dock_right { right: ").concat(2+rt,"%; }\n        #croquet_dock_pin { right: ").concat(2,"%; }\n        #croquet_dock_pin.pinned { background: #cce6ff; }\n\n        #croquet_dock_content { position: absolute; left: ").concat(2,"px; top: ").concat(2,"px; right: ").concat(2,"px; bottom: ").concat(2,"px; background: white; }\n        #croquet_dock:not(.active) #croquet_dock_content { display: none; }\n        #croquet_dock:not(.active) #croquet_dock_content div { display: none; }\n\n        #croquet_qrcode { position: absolute; border: 6px solid white; width: 100%; height: 100%;box-sizing: border-box; cursor: crosshair; }\n        #croquet_qrcode:not(.active) { display: none; }\n        #croquet_qrcode canvas { image-rendering: pixelated; }\n\n        #croquet_stats { position: absolute; width: 70%; height: 90%; left: 15%; top: 5%; opacity: 0.8; font-family: sans-serif; }\n        #croquet_stats:not(.active) { display: none; }\n\n        #croquet_spinnerOverlay {\n            z-index: 1000;\n            position: fixed;\n            left: 0;\n            top: 0;\n            width: 100%;\n            height: 100%;\n            background-color:#333;\n            opacity:0.9;\n            display:flex;\n            align-items:center;\n            justify-content:center;\n            transition: opacity 1.0s ease-out;\n        }\n        /* https://github.com/lukehaas/css-loaders */\n        @keyframes dots {\n            0%, 80%, 100% { box-shadow: 0 2.5em 0 -1.3em; }\n            40% { box-shadow: 0 2.5em 0 0; }\n        }\n        #croquet_loader,\n        #croquet_loader:before,\n        #croquet_loader:after {\n          border-radius: 50%;\n          width: 2.5em;\n          height: 2.5em;\n          animation: dots 1.8s infinite ease-in-out;\n        }\n        #croquet_loader {\n          color: #fff;\n          font-size: 10px;\n          margin: 80px auto;\n          position: relative;\n          text-indent: -9999em;\n          animation-delay: -0.16s;\n        }\n        #croquet_loader:before,\n        #croquet_loader:after {\n          content: '';\n          position: absolute;\n          top: 0;\n        }\n        #croquet_loader:before { left: -3.5em; animation-delay: -0.32s; }\n        #croquet_loader:after { left: 3.5em; }\n"),(Z=document.createElement("style")).innerHTML=X,document.head.insertBefore(Z,document.head.getElementsByTagName("style")[0]),(tt=document.createElement("style")).innerHTML="/*!\n        * Toastify js 1.5.0\n        * https://github.com/apvarun/toastify-js\n        * @license MIT licensed\n        *\n        * Copyright (C) 2018 Varun A P\n        */\n        .toastify {\n            padding: 12px 20px;\n            color: #ffffff;\n            display: inline-block;\n            box-shadow: 0 3px 6px -1px rgba(0, 0, 0, 0.12), 0 10px 36px -4px rgba(77, 96, 232, 0.3);\n            background: -webkit-linear-gradient(315deg, #73a5ff, #5477f5);\n            background: linear-gradient(135deg, #73a5ff, #5477f5);\n            position: fixed;\n            opacity: 0;\n            transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);\n            border-radius: 2px;\n            cursor: pointer;\n            text-decoration: none;\n            max-width: calc(50% - 20px);\n            z-index: 2147483647;\n        }\n        .toastify.on {\n            opacity: 1;\n        }\n        .toast-close {\n            opacity: 0.4;\n            padding: 0 5px;\n        }\n        .toastify-right {\n            right: 15px;\n        }\n        .toastify-left {\n            left: 15px;\n        }\n        .toastify-top {\n            top: -150px;\n        }\n        .toastify-bottom {\n            bottom: -150px;\n        }\n        .toastify-rounded {\n            border-radius: 25px;\n        }\n        .toastify-avatar {\n            width: 1.5em;\n            height: 1.5em;\n            margin: 0 5px;\n            border-radius: 2px;\n        }\n        @media only screen and (max-width: 360px) {\n            .toastify-right, .toastify-left {\n                margin-left: auto;\n                margin-right: auto;\n                left: 0;\n                right: 0;\n                max-width: fit-content;\n            }\n        }\n\n        .toastify { font-family: sans-serif; border-radius: 8px; }\n",document.head.insertBefore(tt,document.head.getElementsByTagName("style")[0]);var ot=new Set;function it(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t&&wt.showMessage(t,Y({},e,{level:"error"}))}function at(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t&&wt.showMessage(t,Y({},e,{level:"warning"}))}function st(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t&&wt.showMessage(t,Y({},e,{level:"status"}))}function ct(t,e){console.error("Error during ".concat(t),e);var n=(e.stack||"").split("\n").filter((function(t){return!t.match(/croquet-.*\.min.js/)})).join("\n");wt.showMessage("<b>Error during ".concat(t,": ").concat(e.message,"</b>\n\n").concat(n).replace(/\n/g,"<br>"),{level:"error",duration:1e4,stopOnFocus:!0})}function ut(t,e){var n=wt.root;if(!1===n)return null;var r,o=Y({text:t,duration:3e3,gravity:"bottom",position:"left",backgroundColor:"linear-gradient(to right, #00b09b, #96c93d)",stopOnFocus:!0},e);return n instanceof Element&&n!==document.body?(r=n.id)||(n.id=r="_croquetToastParent"):"string"==typeof n&&(r=n),r&&(o.selector=r),s(o).showToast()}var lt,ht,ft=!1,dt=null;function vt(t,e,n){var r=document.createElement("canvas"),o=r.width=40*nt/12,i=r.height=60,a=r.getContext("2d");a.font="36px Arial",a.textAlign="center",a.textBaseline="middle",a.fillStyle="black",a.fillText(t,o/2,.55*i);var s=document.createElement("button");s.id=e,s.className="croquet_dock_button";var c=function(t){t.preventDefault(),t.stopPropagation(),n()};return et?s.ontouchstart=c:s.onclick=c,s.appendChild(r),s}function pt(t,e){if(!1!==wt.badge){var n=function(t){for(var e=new c(t),n=["bcdfghjklmnpqrstvwxyz","aeiou"],r="",o=0;o<5;o++)r+=n[o%2][e.quick()*n[o%2].length|0];return r}(e);for(document.title=document.title.replace(/:.*/,""),document.title+=":"+n;t.firstChild;)t.removeChild(t.firstChild);var r=document.createElement("canvas"),o=r.width=120,i=r.height=40;r.style.width="100%",t.appendChild(r);var a=r.getContext("2d"),s=function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=new c(t),r=[],o=0;o<e;o++)r.push("hsl(".concat(360*n.quick(),", 50%, 70%)"));return r}(e,2);a.fillStyle=s[0],a.beginPath(),a.moveTo(0,0),a.lineTo(0,i),a.lineTo(o,0),a.closePath(),a.fill(),a.fillStyle=s[1],a.beginPath(),a.moveTo(o,i),a.lineTo(o,0),a.lineTo(0,i),a.closePath(),a.fill(),a.font="30px Arial",a.textAlign="center",a.textBaseline="middle",a.fillStyle="black",a.fillText(n,o/2,i/2)}}function yt(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};t.firstChild;)t.removeChild(t.firstChild);return new S(t,Y({text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:S.CorrectLevel.L},n))}var mt=0;function gt(t){if(ht!==t)if(!1===wt.sync&&(t=!1),t&&!lt&&(lt=function(){var t=document.createElement("div");t.id="croquet_spinnerOverlay";var e=document.createElement("div");return e.id="croquet_loader",e.innerText="Catching up...",t.appendChild(e),t}()),ht=t,t)clearTimeout(mt),mt=setTimeout((function(){ht&&(bt(wt.root,(function(){return document.body})).appendChild(lt),lt.style.opacity=.9)}),500);else{if(!lt)return;clearTimeout(mt),lt.style.opacity=0,mt=setTimeout((function(){ht||lt.parentElement&&lt.parentElement.removeChild(lt)}),500)}}function bt(t,e){if(!1===t)return!1;if(t instanceof Element)return t;if("string"==typeof t){var n=document.getElementById(t);if(n)return n}return e?e():null}var wt={sessionURL:window.location.href,root:document.body,sync:!0,messages:!1,badge:!1,stats:!1,qrcode:!1,makeWidgetDock:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!I.nodock){var e=document.getElementById("croquet_dock");e&&e.parentElement.removeChild(e);var n=bt(wt.root);if(n){var r=document.createElement("div");r.id="croquet_dock",n.appendChild(r);var o,i=document.createElement("div");i.id="croquet_dock_bar",r.appendChild(i),!1!==t.badge&&((o=document.createElement("div")).id="croquet_badge",i.appendChild(o),wt.badge=o);var a=document.createElement("div");a.id="croquet_dock_content",r.appendChild(a);var s,c,u=[];if(!1!==t.qrcode){var l=wt.sessionURL;l&&((s=document.createElement("div")).id="croquet_qrcode",a.appendChild(s),u.push(s.id),wt.qrcode=s)}if(!1!==t.stats&&((c=document.createElement("div")).id="croquet_stats",a.appendChild(c),u.push(c.id),wt.stats=c),u.length){var h=function(t){var e,n=u.length,r=0;if(dt){var o=u.indexOf(dt);o>=0?(r=o,e=document.getElementById(dt)):dt=null}var i,a=u[(r+n+t)%n];a===dt?i=e:(e&&e.classList.remove("active"),i=document.getElementById(a)),i&&i.classList.add("active"),dt=a};u.length>1&&(i.appendChild(vt("<","croquet_dock_left",(function(){return h(-1)}))),i.appendChild(vt(">","croquet_dock_right",(function(){return h(1)})))),h(0)}if(!et){var f=vt("üìå","croquet_dock_pin",(function(){ft=!ft,d()})),d=function(){ft?f.classList.add("pinned"):f.classList.remove("pinned")};d(),i.appendChild(f)}var v=200,p=166,y=8,m=function(t){r.style.width="".concat(t,"px"),r.style.height="".concat(1.18*t,"px");var e=18*t/100;i.style.height="".concat(e,"px"),a.style.top="".concat(e+2,"px"),o&&(o.style.height="".concat(.9*e,"px"),o.style.width="".concat(.9*e*3,"px")),s&&(s.style.border="".concat(y*t/v,"px solid white"))},g=function(){r.style.width=r.style.height="",i.style.height="",a.style.top="",o&&(o.style.height=o.style.width=""),s&&(s.style.border="")},b=v,w=function(){return r.classList.contains("active")},k=function(){r.classList.add("active"),m(b),setTimeout((function(){return r.style.transition="none"}),300)},S=function(){r.style.transition="",r.classList.remove("active"),g()};if(et)S(),r.ontouchstart=function(t){t.preventDefault(),t.stopPropagation(),w()?S():k()};else{ft?k():S();var x=0;r.onwheel=function(t){t.preventDefault(),t.stopPropagation();var e=Date.now();if(!(e-x<100)){x=e;var n=t.deltaY;n=Math.sign(n)*Math.min(5,Math.abs(n));var o=.8*Math.min(window.innerWidth,window.innerHeight);b=Math.max(p,Math.min(o,r.offsetWidth*Math.pow(1.05,n))),m(b)}},r.onmouseenter=k,r.onmouseleave=function(){ft||S()}}}}},makeSessionWidgets:function(t){!function(t){if(t&&!1!==wt.root){var e=bt(wt.badge);e&&pt(e,t)}}(t),function(){if(!1!==wt.root&&!1!==wt.qrcode&&!I.noqr){var t=wt.sessionURL;if(t){var e=bt(wt.qrcode);if(e)et||(e.onclick=function(e){e.preventDefault(),e.stopPropagation(),window.open(t)}),yt(e,t).getCanvas().style.width="100%"}else console.warn("App.sessionURL is not set")}}(),function(){if(!1!==wt.root&&!I.nostats){var t=bt(wt.stats);t&&U(t)}}()},makeQRCanvas:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!wt.sessionURL)return null;var e=document.createElement("div"),n=yt(e,wt.sessionURL,t);return n&&n.getCanvas()},clearSessionMoniker:function(){!1!==wt.badge&&(document.title=document.title.replace(/:.*/,""))},showSyncWait:function(t){!1===wt.root&&(t=!1),gt(t)},messageFunction:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("once"===e.only){if(ot.has(t))return null;ot.add(t)}var n,r=e.level;return"error"===r?(n="red",console.error(t)):"warning"===r?(n="gold",console.warn(t)):n="#aaa",ut(t,Y({backgroundColor:n},e))},showMessage:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return I.nomessages||!1===wt.root||!1===wt.messages||!wt.messageFunction?null:wt.messageFunction(t,e)}};function kt(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r={};try{r=JSON.parse(localStorage.croquetUser||"{}")}catch(t){}return t in r?r[t]:n?(r[t]=n(),r[t]!==e&&(localStorage.croquetUser=JSON.stringify(r)),r[t]):e}function St(){return xt.apply(this,arguments)}function xt(){return(xt=i(e.mark((function t(){return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!I.nologin){t.next=2;break}return t.abrupt("return",!1);case 2:if(!kt("name")||I.user){t.next=4;break}return t.abrupt("return",!0);case 4:return t.abrupt("return",new Promise((function(t){var r=document.createElement("style");r.innerHTML='\n            .overlay {\n                z-index: 1010;\n                position: fixed;\n                left: 0;\n                top: 0;\n                width: 100%;\n                height: 100%;\n                background-color:#333;\n                opacity:0.9;\n                display:flex;\n                align-items:center;\n                justify-content:center\n            }\n            form {\n                background-color: #fff;\n                color: #666;\n                border-radius: 10px;\n                padding: 16px;\n                font-size: 14px;\n            }\n            form dt { margin: 4px 0 }\n            form dd { margin-left: 0 }\n            form input {\n                border: 1px solid #ccc;\n                border-radius: 5px;\n                min-height: 46px;\n                padding: 10px;\n                font-size: 16px;\n                width: 100%;\n                box-shadow: inset 0 1px 2px #666;\n            }\n            form input:invalid { border: 1px solid red; }\n            form input:valid   { border: 1px solid #ccc; }\n            form button {\n                padding: 20px 32px;\n                background-color: #3b5;\n                color: #fff;\n                border-radius: 50px;\n                border-width:0;\n                font-size: 16px;\n                font-weight: 500;\n                width: 100%;\n            }\n            .error {\n                visibility: hidden;\n                width: 250px;\n                background-color: #fcc;\n                color: #900;\n                padding: 5px;\n                border-radius: 6px;\n                border: 1px solid #c99;\n                position: absolute;\n                margin-top: 5px;\n                font-size: 12px;\n            }\n            .error::after {\n                content: " ";\n                position: absolute;\n                bottom: 100%;  /* At the top of message */\n                left: 10px;\n                border-width: 5px;\n                border-style: solid;\n                border-color: transparent transparent #c99 transparent;\n            }\n            .notice {\n                visibility: hidden;\n                width: 270px;\n                height: 70px;\n                background-color: #fff;\n                padding: 5px;\n                position: absolute;\n                margin-top: 5px;\n                font-size: 12px;\n            }\n        ',document.head.appendChild(r);var o=document.createElement("form");o.innerHTML='\n            <dl>\n                <dt><label for="user[name]">Username</label></dt>\n                <dd>\n                    <input type="text" required pattern="^[a-zA-Z0-9_]*$" minlength="2" maxlength="15" name="user[name]" id="user[name]" placeholder="Enter a username" autocomplete="off" spellcheck="false"></input>\n                </dd>\n                <dd class="error"></dd>\n                <dd class="notice"></dd>\n            </dl>\n            <dl>\n                <dt><label for="user[email]">Email</label></dt>\n                <dd>\n                    <input type="email" required id="user[email]" placeholder="you@example.com" autocomplete="off" spellcheck="false"></input>\n                </dd>\n                <dd class="error"></dd>\n            </dl>\n            <dl>\n                <dt><label for="user[password]">Password</label></dt>\n                <dd>\n                    <input type="password" required minlength="8" id="user[password]" placeholder="Create a password" autocomplete="off" spellcheck="false"></input>\n                </dd>\n                <dd class="error"></dd>\n            </dl>\n            <button id="user[create]">Sign up / Log in</button>\n            <div style="margin:16px auto;text-align: center">‚Äî OR ‚Äî</div>\n            <button id="user[guest]" style="background-color: #999">Continue as Croquet Guest</button>\n            <div style="max-width:280px;text-align: center;font-size:11px;margin:4px auto">\n                Continuing from this screen to our website indicates that you agree to our\n                <a href="/terms.html" target="_blank" style="color:#36c;text-decoration:none">terms of service</a>\n                and\n                <a href="/privacy.html" target="_blank" style="color:#36c;text-decoration:none">privacy statement</a>.\n            </div>\n        ';var a=document.createElement("div");a.classList.add("overlay"),a.appendChild(o),document.body.appendChild(a);var s=o.getElementsByTagName("input"),c=n(s,3),u=c[0],l=c[1],h=c[2],f=o.getElementsByClassName("error"),d=n(f,3),v=d[0],p=d[1],y=d[2],m=o.getElementsByClassName("notice"),g=n(m,1)[0],b=o.getElementsByTagName("button"),w=n(b,2),k=w[0],S=w[1];"string"==typeof I.user?u.value=I.user:kt("name")&&(u.value=kt("name"));var x=0;u.oninput=function(){clearTimeout(x),x=setTimeout((function(){return T()}),300)},q(!0),u.oninput();var C=0;l.oninput=function(){clearTimeout(C),C=setTimeout((function(){return M()}),300)};var E=0;function O(){o.reset(),document.head.removeChild(r),document.body.removeChild(a)}function _(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:".json";return"".concat(At(),"/user/").concat(t.toLowerCase(),"/").concat(e).concat(n)}function T(){return A.apply(this,arguments)}function A(){return(A=i(e.mark((function t(){var n,r,o,i,a,s=arguments;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=s.length>0&&void 0!==s[0]&&s[0],v.style.visibility="hidden",n||q(!0),(r=u.value.trim())||n){t.next=6;break}return t.abrupt("return",!1);case 6:if(!u.validity.tooShort&&!u.validity.tooLong){t.next=10;break}return v.innerHTML="Your username must be between ".concat(u.minLength," and ").concat(u.maxLength," characters long."),v.style.visibility="visible",t.abrupt("return",!1);case 10:if(!u.validity.patternMismatch){t.next=14;break}return v.innerHTML="Your username can only contain alphanumeric characters (letters A-Z, numbers 0-9) and underscores.",v.style.visibility="visible",t.abrupt("return",!1);case 14:return t.prev=14,o=x,t.next=18,fetch(_(r,"salt"),{mode:"cors"});case 18:if(i=t.sent,o===x||n){t.next=21;break}return t.abrupt("return",!1);case 21:if(!i.ok){t.next=27;break}return n||q(!1),t.next=25,i.json();case 25:return a=t.sent,t.abrupt("return",{name:r,salt:Nt(a.salt)});case 27:t.next=31;break;case 29:t.prev=29,t.t0=t.catch(14);case 31:return t.abrupt("return",{name:r});case 32:case"end":return t.stop()}}),t,null,[[14,29]])})))).apply(this,arguments)}function M(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];p.style.visibility="hidden";var e=l.value.trim();return!(!e&&!t)&&(l.validity.valid?e:(p.innerHTML="Please enter a valid email address.",p.style.visibility="visible",!1))}function j(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];y.style.visibility="hidden";var e=h.value;return!(!e&&!t)&&(h.validity.tooShort?(y.innerHTML="Your password must be at least ".concat(h.minLength," characters long."),y.style.visibility="visible",!1):e)}function q(t){var e=u.value.trim();g.innerHTML="‚Äú".concat(e,"‚Äù is already registered as a user.<br><br>\n                If this is you, please enter your password below to continue.\n                Otherwise, please pick a different name."),g.style.visibility=t?"hidden":"visible",l.disabled=!t,h.placeholder=e?t?"Create a password for ‚Äú".concat(e,"‚Äù"):"Enter password for ‚Äú".concat(e,"‚Äù"):"Enter a password",k.innerHTML=e?t?"Sign up as ‚Äú".concat(e,"‚Äù"):"Log in as ‚Äú".concat(e,"‚Äù"):"Sign up / Log in"}h.oninput=function(){clearTimeout(E),E=setTimeout((function(){return j()}),300)},k.onclick=function(){var n=i(e.mark((function n(r){var o,i,a,s,c,u,l,h,f,d,v,p,m;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.preventDefault(),e.next=3,T(!0);case 3:if(o=e.sent,i=o.name,a=o.salt,s=!!a||M(!0),c=j(!0),i&&s&&c){e.next=10;break}return e.abrupt("return");case 10:return(u=a)||(u=crypto.getRandomValues(new Uint8Array(8)),fetch(_(i,"salt"),{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({salt:Pt(u)})})),e.next=14,window.crypto.subtle.importKey("raw",(new TextEncoder).encode(c),{name:"PBKDF2"},!1,["deriveBits"]);case 14:return l=e.sent,e.next=17,window.crypto.subtle.deriveBits({name:"PBKDF2",salt:u,iterations:5e5,hash:"SHA-256"},l,256);case 17:if(h=e.sent,f=Pt(h),!a){e.next=40;break}return e.prev=20,e.next=23,fetch(_(i,f),{mode:"cors"});case 23:if((d=e.sent).ok){e.next=26;break}throw Error("wrong password");case 26:return e.next=28,d.json();case 28:v=e.sent,console.log("Logged in as ".concat(v.name," <").concat(v.email,">")),localStorage.croquetUser=JSON.stringify(v),e.next=38;break;case 33:return e.prev=33,e.t0=e.catch(20),y.innerHTML="Wrong password for ‚Äú".concat(i,"‚Äú"),y.style.visibility="visible",e.abrupt("return");case 38:e.next=45;break;case 40:p=crypto.getRandomValues(new Uint8Array(16)),m={name:i,email:s,salt:Pt(u),secret:Pt(p)},localStorage.croquetUser=JSON.stringify(m),fetch(_(i,f),{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)}),console.log("Signed up as ".concat(m.name," <").concat(m.email,">"));case 45:O(),t(!0);case 47:case"end":return e.stop()}}),n,null,[[20,33]])})));return function(t){return n.apply(this,arguments)}}(),S.onclick=function(e){e.preventDefault(),delete localStorage.croquetUser,O(),t(!1)}})));case 5:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Ct(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function Et(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Ct(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ct(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function Ot(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return _t(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _t(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,i=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function _t(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var Tt=window.location.hostname.endsWith("croquet.io")?window.location.host:"croquet.io";function At(){var t="string"==typeof I.files?I.files:"https://".concat(Tt,"/files/v1");return t.endsWith("/")?t.slice(0,-1):t}function Mt(){return module.bundle?module.bundle.modules:[]}function It(){return Object.keys(Mt()).filter((function(t){return!t.endsWith("hmr-runtime.js")}))}function jt(t){return Mt()[t]}function qt(t){var e,n,r,o;return e=jt(t)[0],r=(n=""+e).indexOf("{"),o=n.lastIndexOf("}"),n.slice(r+1,o).trim()}function Nt(t){return new Uint8Array(atob(t.padEnd(t.length+3&-4,"=").replace(/-/g,"+").replace(/_/g,"/")).split("").map((function(t){return t.charCodeAt(0)})))}function Pt(t){return btoa(String.fromCharCode.apply(String,r(new Uint8Array(t)))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function Dt(t){return Rt.apply(this,arguments)}function Rt(){return(Rt=i(e.mark((function t(n){var r;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==n.length){t.next=2;break}return t.abrupt("return","47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU");case 2:return t.next=4,window.crypto.subtle.digest("SHA-256",n);case 4:return r=t.sent,t.abrupt("return",Pt(r));case 6:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Lt(){return I.has("debug","hashing",!1)}window.crypto&&window.crypto.subtle&&"function"==typeof window.crypto.subtle.digest||console.error("ERROR: crypto.subtle.digest() browser API not available. Please access this page via https or localhost.");var Bt={},Ft={was_initialized:!1};function Ut(t){return Ft.was_initialized||function(){var t,e=Ot(It());try{for(e.s();!(t=e.n()).done;)for(var r=t.value,o=0,i=Object.entries(jt(r)[1]);o<i.length;o++){var a=n(i[o],2),s=a[0],c=a[1],u=Ft[c]||"",l=s.replace(/^[./]*/,"");l.length>u.length&&(Ft[c]=l)}}catch(t){e.e(t)}finally{e.f()}Ft.was_initialized=!0}(),Ft[t]||t}var Ht=new TextEncoder;function $t(t){return Vt.apply(this,arguments)}function Vt(){return(Vt=i(e.mark((function t(n){var r,o;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=Ht.encode(n),t.next=3,Dt(r);case 3:return o=t.sent,Lt()&&(Bt[o]={string:n,buffer:r}),t.abrupt("return",o);case 6:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var Jt={};function Wt(t){return zt.apply(this,arguments)}function zt(){return(zt=i(e.mark((function t(n){var r,o;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Jt[n]){t.next=2;break}return t.abrupt("return",Jt[n]);case 2:return r=qt(n).replace(/\s+/g," "),t.next=5,$t(r);case 5:return o=t.sent,Lt()&&(Bt[o].name="Module ".concat(Ut(n))),t.abrupt("return",Jt[n]=o);case 8:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var Gt=[];function Kt(t){var e=$t(function(t){var e=""+t,n=e.indexOf("{"),r=e.lastIndexOf("}"),o=e.slice(0,n).replace(/\s+/g," ").trim(),i=e.slice(n+1,r).trim();return"".concat(o," {\n").concat(i,"}")}(t));e.then((function(e){console.log("hashing class ".concat(t.name,": ").concat(e)),Lt()&&(Bt[e].name="Class ".concat(t.name))})),Gt.push(e)}function Qt(t,e){return Yt.apply(this,arguments)}function Yt(){return(Yt=i(e.mark((function t(n,o){var i,a,s,c,u;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i="production"===b?[]:It().filter((function(t){var e=t.endsWith("/package.json")||t.endsWith("/ar.js");return e&&console.warn("excluding ".concat(t," from code hash")),!e})).sort(),t.next=4,Promise.all([].concat(r(i.map(Wt)),Gt));case 4:return a=t.sent,t.next=7,$t([o].concat(r(a)).join("|"));case 7:return s=t.sent,t.next=10,$t([n,s].join("|"));case 10:return c=t.sent,Lt()&&(Bt[s].name="All code",Bt[c].name="Session name and code",u=[].concat(r(a),[s,c]).map((function(t){return Et({hash:t},Bt[t])})),console.log("Debug Hashing for session ".concat(c),u)),t.abrupt("return",{hash:c,codeHash:s});case 13:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Xt(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return Zt(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Zt(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,i=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function Zt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var te=function(){function t(){u(this,t),this.values=[],this.resolves=[]}var n;return l(t,[{key:"next",value:(n=i(e.mark((function t(){var n=this;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(this.values.length>0)){t.next=2;break}return t.abrupt("return",this.values.shift());case 2:return t.abrupt("return",new Promise((function(t){return n.resolves.push(t)})));case 3:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"put",value:function(t){var e=this.resolves.shift();e?e(t):this.values.push(t)}},{key:"putAll",value:function(t){var e,n=Xt(t);try{for(n.s();!(e=n.n()).done;){var r=e.value;this.put(r)}}catch(t){n.e(t)}finally{n.f()}}},{key:"peek",value:function(){return this.values[0]}},{key:"nextNonBlocking",value:function(){return this.values.shift()}},{key:"allNonBlocking",value:function(){if(0===this.values.length)return[];var t=this.values;return this.values=[],t}},{key:"size",get:function(){return this.values.length-this.resolves.length}}]),t}();function ee(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var ne=function(t){d(r,y);var e,n=(e=r,function(){var t,n=p(e);if(ee()){var r=p(this).constructor;t=Reflect.construct(n,arguments,r)}else t=n.apply(this,arguments);return v(this,t)});function r(){return u(this,r),n.apply(this,arguments)}return l(r,[{key:"poll",value:function(){var t=f(p(r.prototype),"poll",this).call(this);return this.array[this.size]=null,t}},{key:"asArray",value:function(){var t=[];return this.forEach((function(e){return t.push(e)})),t}},{key:"asUnsortedArray",value:function(){return this.array.slice(0,this.size)}}]),r}();function re(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return oe(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return oe(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,i=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function oe(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function ie(t,e){function n(t){var n,r=re(t);try{for(r.s();!(n=r.n()).done;){var o=n.value;o.for===e&&t.delete(o)}}catch(t){r.e(t)}finally{r.f()}}return n(t.immediate),n(t.oncePerFrame),n(t.oncePerFrameWhileSynced),n(t.queued),t.immediate.size+t.queued.size+t.oncePerFrame.size+t.oncePerFrameWhileSynced.size}var ae=new(function(){function t(){u(this,t),this.subscriptions={},this.queuedEvents=[],this.perFrameEvents=new Map,this.perSyncedFrameEvents=new Map,this.id=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(function(t){return(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)})),this.lastId=0}return l(t,[{key:"register",value:function(t){return this.id+"/V"+ ++this.lastId}},{key:"deregister",value:function(t){}},{key:"addSubscription",value:function(t,e,n,r,o){if("vote"!==o){var i=t+":"+e,a=r;a.for=n;var s=this.subscriptions[i];if(s||(s=this.subscriptions[i]={immediate:new Set,queued:new Set,oncePerFrame:new Set,oncePerFrameWhileSynced:new Set}),!s[o])throw Error('Unknown subscribe() option: handling="'.concat(o,'"'));s[o].add(a)}else this.addSubscription(t,e+"#__vote",n,r,"immediate")}},{key:"removeSubscription",value:function(t,e,n){var r=t+":"+e,o=this.subscriptions[r];o&&(0===ie(o,n)&&delete this.subscriptions[r]);e.endsWith("#__vote")||this.removeSubscription(t,e+"#__vote",n)}},{key:"removeAllSubscriptionsFor",value:function(t){for(var e="".concat(t,":"),r=0,o=Object.entries(this.subscriptions);r<o.length;r++){var i=n(o[r],2),a=i[0],s=i[1];if(a.startsWith(e))delete this.subscriptions[a];else 0===ie(s,t)&&delete this.subscriptions[a]}}},{key:"handleEvent",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(t){return t()},r=this.subscriptions[t];r&&(r.queued.size>0&&this.queuedEvents.push({topic:t,data:e}),r.oncePerFrame.size>0&&this.perFrameEvents.set(t,e),r.oncePerFrameWhileSynced.size>0&&this.perSyncedFrameEvents.set(t,e),r.immediate.size>0&&n((function(){var t,n=re(r.immediate);try{for(n.s();!(t=n.n()).done;){(0,t.value)(e)}}catch(t){n.e(t)}finally{n.f()}})))}},{key:"processFrameEvents",value:function(t){var e,r=this,o=0,i=function(t,e,n){var i=r.subscriptions[t];if(i){var a,s=re(i[n]);try{for(s.s();!(a=s.n()).done;){(0,a.value)(e),o++}}catch(t){s.e(t)}finally{s.f()}}},a=re(this.queuedEvents);try{for(a.s();!(e=a.n()).done;){var s=e.value;i(s.topic,s.data,"queued")}}catch(t){a.e(t)}finally{a.f()}this.queuedEvents.length=0;var c,u=re(this.perFrameEvents);try{for(u.s();!(c=u.n()).done;){var l=n(c.value,2);i(l[0],l[1],"oncePerFrame")}}catch(t){u.e(t)}finally{u.f()}if(this.perFrameEvents.clear(),t){var h,f=re(this.perSyncedFrameEvents);try{for(f.s();!(h=f.n()).done;){var d=n(h.value,2);i(d[0],d[1],"oncePerFrameWhileSynced")}}catch(t){f.e(t)}finally{f.f()}this.perSyncedFrameEvents.clear()}var v,p=re(this.queuedEvents);try{for(p.s();!(v=p.n()).done;){var y=v.value;i(y.topic,y.data,"queued")}}catch(t){p.e(t)}finally{p.f()}return this.queuedEvents.length=0,o}}]),t}());var se={get subscribe(){return(se={subscribe:I.has("debug","subscribe",!1)}).subscribe}},ce=function(){function t(e){u(this,t),this.island=e}return l(t,[{key:"register",value:function(t){return this.island.registerModel(t)}},{key:"deregister",value:function(t){this.island.deregisterModel(t.id)}},{key:"publish",value:function(t,e,n){this.island.publishFromModel(n,t,e)}},{key:"subscribe",value:function(t,e,n,r){return se.subscribe&&console.log('Model.subscribe("'.concat(e,":").concat(n,'", ').concat(t," ").concat((""+r).replace(/\([\s\S]*/,""),")")),this.island.addSubscription(t,e,n,r)}},{key:"unsubscribe",value:function(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"*";se.subscribe&&console.log("Model.unsubscribe(".concat(e,":").concat(n,'", ').concat(t," ").concat((""+r).replace(/\([\s\S]*/,""),")")),this.island.removeSubscription(t,e,n,r)}},{key:"unsubscribeAll",value:function(t){se.subscribe&&console.log("Model.unsubscribeAll(".concat(t," ").concat(t.id,")")),this.island.removeAllSubscriptionsFor(t)}},{key:"future",value:function(t,e,n,r){if(le&&le.equal(this))return this.island.future(t,e,n,r);if(e)throw Error("tOffset not supported from cross-realm future send yet.");var o=this.island;return new Proxy(t,{get:function(e,n){if("function"==typeof t[n])return new Proxy(t[n],{apply:function(e,r,i){o.callModelMethod(t.id,n,i)}});throw Error("Tried to call "+n+"() on future of "+Object.getPrototypeOf(t).constructor.name+" which is not a function")}})}},{key:"random",value:function(){return this.island.random()}},{key:"now",value:function(){return this.island.time}},{key:"equal",value:function(e){return e instanceof t&&e.island===this.island}}]),t}(),ue=function(){function t(e){u(this,t),this.island=e}return l(t,[{key:"register",value:function(t){return ae.register(t)}},{key:"deregister",value:function(t){ae.deregister(t)}},{key:"publish",value:function(t,e,n){this.island.publishFromView(n,t,e)}},{key:"subscribe",value:function(t,e,n,r){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"queued";se.subscribe&&console.log('View.subscribe("'.concat(r,":").concat(t,'", ').concat(e," ").concat(n.name||(""+n).replace(/\([\s\S]*/,"")," [").concat(o,"])")),ae.addSubscription(r,t,e,n,o)}},{key:"unsubscribe",value:function(t,e,n,r){se.subscribe&&console.log('View.unsubscribe("'.concat(r,":").concat(t,'", ').concat(e," ").concat(n.name||(""+n).replace(/\([\s\S]*/,""),")")),ae.removeSubscription(r,t,e,n)}},{key:"unsubscribeAll",value:function(t){se.subscribe&&console.log("View.unsubscribeAll(".concat(t,")")),ae.removeAllSubscriptionsFor(t)}},{key:"future",value:function(t,e){return e?new Proxy(t,{get:function(n,o){if("function"==typeof t[o])return new Proxy(t[o],{apply:function(n,i,a){setTimeout((function(){t.id&&t[o].apply(t,r(a))}),e)}});throw Error("Tried to call "+o+"() on future of "+Object.getPrototypeOf(t).constructor.name+" which is not a function")}}):t}},{key:"random",value:function(){return Math.random()}},{key:"now",value:function(){return this.island.time}},{key:"externalNow",value:function(){return this.island.controller.time}},{key:"isSynced",value:function(){return!!this.island.controller.synced}},{key:"equal",value:function(e){return e instanceof t&&e.island===this.island}}]),t}(),le=null;function he(){if(!le)throw Error("Tried to execute code that requires realm outside of realm.");return le}function fe(t,e){if(null!==le)throw Error("Can't switch realms from inside realm");try{return le=new ce(t),e()}finally{le=null}}function de(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==le&&!n)throw Error("Can't switch realms from inside realm");var r=le;try{return le=new ue(t),e()}finally{le=r}}function ve(t){return function(){var e,n=p(t);if(pe()){var r=p(this).constructor;e=Reflect.construct(n,arguments,r)}else e=n.apply(this,arguments);return v(this,e)}}function pe(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function ye(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return me(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return me(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,i=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function me(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}!function(){var t,e=function(t){return t!=t},n=Math.sqrt,r=.7853981633974483,i=function(t){var o,i,a,s,c;if(e(t))return NaN;if(t>0?a=t:(o=!0,a=-t),a>1)return NaN;if(a>.625)s=(i=1-a)*function(t){var e,n;return 0===t?.08333333333333809:((t<0?-t:t)<=1?(e=28.536655482610616+t*(t*(6.968710824104713+t*(.002967721961301243*t-.5634242780008963))-25.56901049652825),n=342.43986579130785+t*(t*(147.0656354026815+t*(1*t-21.947795316429207))-383.8770957603691)):(e=.002967721961301243+(t=1/t)*(t*(6.968710824104713+t*(28.536655482610616*t-25.56901049652825))-.5634242780008963),n=1+t*(t*(147.0656354026815+t*(342.43986579130785*t-383.8770957603691))-21.947795316429207)),e/n)}(i),i=n(i+i),c=r-i,c-=i=i*s-6123233995736766e-32,c+=r;else{if(a<1e-8)return t;c=a*(c=(i=a*a)*function(t){var e,n;return 0===t?.16666666666666713:((t<0?-t:t)<=1?(e=t*(19.562619833175948+t*(t*(5.444622390564711+t*(.004253011369004428*t-.6019598008014124))-16.262479672107002))-8.198089802484825,n=t*(139.51056146574857+t*(t*(70.49610280856842+t*(1*t-14.740913729888538))-147.1791292232726))-49.18853881490881):(e=.004253011369004428+(t=1/t)*(t*(5.444622390564711+t*(t*(19.562619833175948+-8.198089802484825*t)-16.262479672107002))-.6019598008014124),n=1+t*(t*(70.49610280856842+t*(t*(139.51056146574857+-49.18853881490881*t)-147.1791292232726))-14.740913729888538)),e/n)}(i))+a}return o?-c:c},a="function"==typeof Symbol&&"symbol"==o(Symbol("foo")),s=Object.prototype.toString,c=Object.prototype.hasOwnProperty,u="function"==typeof Symbol?Symbol.toStringTag:"",l={};t=a&&"symbol"==o(Symbol.toStringTag)?function(t){var e,n,r;if(null==t)return s.call(t);n=t[u],e=function(t,e){return null!=t&&c.call(t,e)}(t,u);try{t[u]=void 0}catch(e){return s.call(t)}return r=s.call(t),e?t[u]=n:delete t[u],r}:function(t){return s.call(t)},l=t;var h="function"==typeof Uint32Array,f="function"==typeof Uint32Array?Uint32Array:null,d="function"==typeof Uint32Array?Uint32Array:null,v={};v=function(){var t,e;if("function"!=typeof f)return!1;try{t=function(t){return h&&t instanceof Uint32Array||"[object Uint32Array]"===l(t)}(e=new f(e=[1,3.14,-3.14,4294967296,4294967297]))&&1===e[0]&&3===e[1]&&4294967293===e[2]&&0===e[3]&&1===e[4]}catch(e){t=!1}return t}()?d:function(){throw new Error("not implemented")};var p="function"==typeof Float64Array,y="function"==typeof Float64Array?Float64Array:null,m="function"==typeof Float64Array?Float64Array:null,g={};g=function(){var t,e;if("function"!=typeof y)return!1;try{t=function(t){return p&&t instanceof Float64Array||"[object Float64Array]"===l(t)}(e=new y([1,3.14,-3.14,NaN]))&&1===e[0]&&3.14===e[1]&&-3.14===e[2]&&e[3]!=e[3]}catch(e){t=!1}return t}()?m:function(){throw new Error("not implemented")};var b,w="function"==typeof Uint8Array,k="function"==typeof Uint8Array?Uint8Array:null,S="function"==typeof Uint8Array?Uint8Array:null;b=function(){var t,e;if("function"!=typeof k)return!1;try{t=function(t){return w&&t instanceof Uint8Array||"[object Uint8Array]"===l(t)}(e=new k(e=[1,3.14,-3.14,256,257]))&&1===e[0]&&3===e[1]&&253===e[2]&&0===e[3]&&1===e[4]}catch(e){t=!1}return t}()?S:function(){throw new Error("not implemented")};var x,C="function"==typeof Uint16Array,E="function"==typeof Uint16Array?Uint16Array:null,O="function"==typeof Uint16Array?Uint16Array:null,_={uint16:function(){var t,e;if("function"!=typeof E)return!1;try{t=function(t){return C&&t instanceof Uint16Array||"[object Uint16Array]"===l(t)}(e=new E(e=[1,3.14,-3.14,65536,65537]))&&1===e[0]&&3===e[1]&&65533===e[2]&&0===e[3]&&1===e[4]}catch(e){t=!1}return t}()?O:function(){throw new Error("not implemented")},uint8:b};(x=new _.uint16(1))[0]=4660;var T,A=52===new _.uint8(x.buffer)[0];T=!0===A?1:0;var M,I=new g(1),j=new v(I.buffer),q=function(t){return I[0]=t,j[T]};M=!0===A?1:0;var N,P,D,R=new g(1),L=new v(R.buffer),B=function(t,e){return R[0]=t,L[M]=e>>>0,R[0]},F=Number.POSITIVE_INFINITY,U=Number.NEGATIVE_INFINITY,H=.6931471803691238,$=1.9082149292705877e-10,V=function(t){var n,r,o,i,a,s,c,u,l,h;if(t<-1||e(t))return NaN;if(-1===t)return U;if(t===F)return t;if(0===t)return t;if(h=1,(o=t<0?-t:t)<.41421356237309503){if(o<1.862645149230957e-9)return o<5551115123125783e-32?t:t-t*t*.5;t>-.2928932188134525&&(h=0,i=t,r=1)}return 0!==h&&(o<9007199254740992?(a=(h=((r=q(l=1+t))>>20)-1023)>0?1-(l-t):t-(l-1),a/=l):(h=((r=q(l=t))>>20)-1023,a=0),(r&=1048575)<434334?l=B(l,1072693248|r):(h+=1,l=B(l,1071644672|r),r=1048576-r>>2),i=l-1),n=.5*i*i,0===r?0===i?h*H+(a+=h*$):h*H-((u=n*(1-.6666666666666666*i))-(h*$+a)-i):(u=(c=(s=i/(2+i))*s)*function(t){return 0===t?.6666666666666735:.6666666666666735+t*(.3999999999940942+t*(.2857142874366239+t*(.22222198432149784+t*(.1818357216161805+t*(.15313837699209373+.14798198605116586*t)))))}(c),0===h?i-(n-s*(n+u)):h*H-(n-(s*(n+u)+(h*$+a))-i))},J=.6931471805599453,W=1.9082149292705877e-10,z=function(t){var n,r,o,i,a,s,c,u,l,h,f;return 0===t?U:e(t)||t<0?NaN:(i=0,(r=q(t))<1048576&&(i-=54,r=q(t*=0x40000000000000)),r>=2146435072?t+t:(i+=(r>>20)-1023|0,i+=(c=614244+(r&=1048575)&1048576|0)>>20|0,s=(t=B(t,r|1072693248^c))-1,(1048575&2+r)<3?0===s?0===i?0:.6931471803691238*i+i*W:(a=s*s*(.5-.3333333333333333*s),0===i?s-a:.6931471803691238*i-(a-i*W-s)):(c=r-398458|0,u=440401-r|0,o=(h=(f=(l=s/(2+s))*l)*f)*function(t){return 0===t?.3999999999940942:.3999999999940942+t*(.22222198432149784+.15313837699209373*t)}(h),a=f*function(t){return 0===t?.6666666666666735:.6666666666666735+t*(.2857142874366239+t*(.1818357216161805+.14798198605116586*t))}(h)+o,(c|=u)>0?(n=.5*s*s,0===i?s-(n-l*(n+a)):.6931471803691238*i-(n-(l*(n+a)+i*W)-s)):0===i?s-l*(s-a):.6931471803691238*i-(l*(s-a)-i*W-s))))},G=function(t){return t===F||t===U},K=1.5707963267948966,Q=function(t){var n,o,i,a;return e(t)||0===t?t:t===F?K:t===U?-K:(t<0&&(o=!0,t=-t),n=0,t>2.414213562373095?(i=K,n=1,t=-1/t):t<=.66?i=0:(i=r,n=2,t=(t-1)/(t+1)),a=t*(a=(a=t*t)*function(t){return 0===t?-64.85021904942025:t*(t*(t*(-.8750608600031904*t-16.157537187333652)-75.00855792314705)-122.88666844901361)-64.85021904942025}(a)/function(t){return 0===t?194.5506571482614:194.5506571482614+t*(485.3903996359137+t*(432.88106049129027+t*(165.02700983169885+t*(24.858464901423062+1*t))))}(a))+t,2===n?a+=3061616997868383e-32:1===n&&(a+=6123233995736766e-32),i+=a,o?-i:i)};!0===A?(P=1,D=0):(P=0,D=1),N={HIGH:P,LOW:D};var Y,X,Z,tt=new g(1),et=new v(tt.buffer),nt=N.HIGH,rt=N.LOW,ot=function(t,e){return tt[0]=e,t[0]=et[nt],t[1]=et[rt],t},it=function(t,e){return 1===arguments.length?ot([0,0],t):ot(t,e)};!0===A?(X=1,Z=0):(X=0,Z=1),Y={HIGH:X,LOW:Z};var at,st=new g(1),ct=new v(st.buffer),ut=Y.HIGH,lt=Y.LOW,ht=function(t,e){return ct[ut]=t,ct[lt]=e,st[0]},ft=[0,0],dt=function(t,e){var n,r;return it(ft,t),n=ft[0],n&=2147483647,r=q(e),ht(n|=r&=2147483648,ft[1])},vt=3.141592653589793,pt=function(t,e){var n,r,o,i;return o=(i=t*t)*i,r=i*function(t){return 0===t?.0416666666666666:.0416666666666666+t*(2480158728947673e-20*t-.001388888888887411)}(i),r+=o*o*function(t){return 0===t?-2.7557314351390663e-7:t*(2.087572321298175e-9+-11359647557788195e-27*t)-2.7557314351390663e-7}(i),(o=1-(n=.5*i))+(1-o-n+(i*r-t*e))},yt=-.16666666666666632,mt=function(t,e){var n,r,o;return n=.00833333333332249+(o=t*t)*(27557313707070068e-22*o-.0001984126982985795)+o*(o*o)*(1.58969099521155e-10*o-2.5050760253406863e-8),r=o*t,0===e?t+r*(yt+o*n):t-(o*(.5*e-r*n)-e-r*yt)};at=!0===A?0:1;var gt=new g(1),bt=new v(gt.buffer),wt=Math.floor,kt=function(t){return t<0?-t:0===t?0:t},St=function(t,n){return e(n)||G(n)?(t[0]=n,t[1]=0,t):0!==n&&kt(n)<22250738585072014e-324?(t[0]=4503599627370496*n,t[1]=-52,t):(t[0]=n,t[1]=0,t)},xt=[0,0],Ct=[0,0],Et=function(t,n){var r,o;return 0===t||e(t)||G(t)?t:(function(t,e){1===arguments.length?St([0,0],t):St(t,e)}(xt,t),n+=xt[1],(n+=function(t){var e=q(t);return(e=(2146435072&e)>>>20)-1023|0}(t=xt[0]))<-1074?dt(0,t):n>1023?t<0?U:F:(n<=-1023?(n+=52,o=2220446049250313e-31):o=1,it(Ct,t),r=Ct[0],r&=2148532223,o*ht(r|=n+1023<<20,Ct[1])))},Ot=[10680707,7228996,1387004,2578385,16069853,12639074,9804092,4427841,16666979,11263675,12935607,2387514,4345298,14681673,3074569,13734428,16653803,1880361,10960616,8533493,3062596,8710556,7349940,6258241,3772886,3769171,3798172,8675211,12450088,3874808,9961438,366607,15675153,9132554,7151469,3571407,2607881,12013382,4155038,6285869,7677882,13102053,15825725,473591,9065106,15363067,6271263,9264392,5636912,4652155,7056368,13614112,10155062,1944035,9527646,15080200,6658437,6231200,6832269,16767104,5075751,3212806,1398474,7579849,6349435,12618859],_t=[1.570796251296997,7.549789415861596e-8,5390302529957765e-30,3282003415807913e-37,1270655753080676e-44,12293330898111133e-52,27337005381646456e-60,21674168387780482e-67],Tt=5.960464477539063e-8,At=qt(new Array(20)),Mt=qt(new Array(20)),It=qt(new Array(20)),jt=qt(new Array(20));function qt(t){var e,n=t.length;for(e=0;e<n;e++)t[e]=0;return t}var Nt,Pt=Math.round,Dt=function(t,e,n){var r,o,i,a,s;return i=t-1.5707963267341256*(r=Pt(.6366197723675814*t)),a=6077100506506192e-26*r,s=e>>20|0,n[0]=i-a,s-(q(n[0])>>20&2047)>16&&(a=20222662487959506e-37*r-((o=i)-(i=o-(a=6077100506303966e-26*r))-a),n[0]=i-a,s-(q(n[0])>>20&2047)>49&&(a=84784276603689e-45*r-((o=i)-(i=o-(a=20222662487111665e-37*r))-a),n[0]=i-a)),n[1]=i-n[0]-a,r},Rt=1.5707963267341256,Lt=6077100506506192e-26,Bt=2*Lt,Ft=4*Lt,Ut=new Array(3),Ht=new Array(2),$t=function(t,e){var n,r,o,i,a,s,c;if((o=2147483647&q(t)|0)<=1072243195)return e[0]=t,e[1]=0,0;if(o<=1074752122)return 598523==(1048575&o)?Dt(t,o,e):o<=1073928572?t>0?(c=t-Rt,e[0]=c-Lt,e[1]=c-e[0]-Lt,1):(c=t+Rt,e[0]=c+Lt,e[1]=c-e[0]+Lt,-1):t>0?(c=t-2*Rt,e[0]=c-Bt,e[1]=c-e[0]-Bt,2):(c=t+2*Rt,e[0]=c+Bt,e[1]=c-e[0]+Bt,-2);if(o<=1075594811)return o<=1075183036?1074977148===o?Dt(t,o,e):t>0?(c=t-3*Rt,e[0]=c-1.8231301519518578e-10,e[1]=c-e[0]-1.8231301519518578e-10,3):(c=t+3*Rt,e[0]=c+1.8231301519518578e-10,e[1]=c-e[0]+1.8231301519518578e-10,-3):1075388923===o?Dt(t,o,e):t>0?(c=t-4*Rt,e[0]=c-Ft,e[1]=c-e[0]-Ft,4):(c=t+4*Rt,e[0]=c+Ft,e[1]=c-e[0]+Ft,-4);if(o<1094263291)return Dt(t,o,e);if(o>=2146435072)return e[0]=NaN,e[1]=NaN,0;for(n=function(t){return gt[0]=t,bt[at]}(t),c=ht(o-((r=(o>>20)-1046)<<20|0),n),a=0;a<2;a++)Ut[a]=0|c,c=16777216*(c-Ut[a]);for(Ut[2]=c,i=3;0===Ut[i-1];)i-=1;return s=function(t,e,n,r){var o,i,a,s,c,u,l;for((i=(n-3)/24|0)<0&&(i=0),s=n-24*(i+1),u=i-(a=r-1),l=a+4,c=0;c<=l;c++)At[c]=u<0?0:Ot[u],u+=1;for(c=0;c<=4;c++){for(o=0,u=0;u<=a;u++)o+=t[u]*At[a+(c-u)];Mt[c]=o}return function t(e,n,r,o,i,a,s,c,u){var l,h,f,d,v,p,y,m,g;for(d=a,g=o[r],m=r,v=0;m>0;v++)h=Tt*g|0,jt[v]=g-16777216*h|0,g=o[m-1]+h,m-=1;if(g=Et(g,i),g-=8*wt(.125*g),g-=y=0|g,f=0,i>0?(y+=v=jt[r-1]>>24-i,jt[r-1]-=v<<24-i,f=jt[r-1]>>23-i):0===i?f=jt[r-1]>>23:g>=.5&&(f=2),f>0){for(y+=1,l=0,v=0;v<r;v++)m=jt[v],0===l?0!==m&&(l=1,jt[v]=16777216-m):jt[v]=16777215-m;if(i>0)switch(i){case 1:jt[r-1]&=8388607;break;case 2:jt[r-1]&=4194303}2===f&&(g=1-g,0!==l&&(g-=Et(1,i)))}if(0===g){for(m=0,v=r-1;v>=a;v--)m|=jt[v];if(0===m){for(p=1;0===jt[a-p];p++);for(v=r+1;v<=r+p;v++){for(u[c+v]=Ot[s+v],h=0,m=0;m<=c;m++)h+=e[m]*u[c+(v-m)];o[v]=h}return t(e,n,r+=p,o,i,a,s,c,u)}}if(0===g)for(r-=1,i-=24;0===jt[r];)r-=1,i-=24;else(g=Et(g,-i))>=16777216?(h=Tt*g|0,jt[r]=g-16777216*h|0,i+=24,jt[r+=1]=h):jt[r]=0|g;for(h=Et(1,i),v=r;v>=0;v--)o[v]=h*jt[v],h*=Tt;for(v=r;v>=0;v--){for(h=0,p=0;p<=d&&p<=r-v;p++)h+=_t[p]*o[v+p];It[r-v]=h}for(h=0,v=r;v>=0;v--)h+=It[v];for(n[0]=0===f?h:-h,h=It[0]-h,v=1;v<=r;v++)h+=It[v];return n[1]=0===f?h:-h,7&y}(t,e,4,Mt,s,4,i,a,At)}(Ut,Ht,r,i),t<0?(e[0]=-Ht[0],e[1]=-Ht[1],-s):(e[0]=Ht[0],e[1]=Ht[1],s)},Vt=[0,0],Jt=Math.ceil,Wt=function(t){var n;return e(t)||t===F?t:t===U?0:t>709.782712893384?F:t<-745.1332191019411?0:t>-1/(1<<28)&&t<1/(1<<28)?1+t:function(t,e,n){var r,o,i,a;return i=(r=t-e)-(o=r*r)*(0===(a=o)?.16666666666666602:.16666666666666602+a*(a*(6613756321437934e-20+a*(4.1381367970572385e-8*a-16533902205465252e-22))-.0027777777777015593)),Et(1-(e-r*i/(2-i)-t),n)}(t-.6931471803691238*(n=function(t){return t<0?Jt(t):wt(t)}(t<0?1.4426950408889634*t-.5:1.4426950408889634*t+.5)),1.9082149292705877e-10*n,n)};Nt=!0===A?0:1;var zt=new g(1),Gt=new v(zt.buffer),Kt=function(t,e){return zt[0]=t,Gt[Nt]=e>>>0,zt[0]},Qt=[0,0],Yt=[0,0],Xt=function(t,e,n){var r,o,i,a,s,c,u,l,h;return(o=2147483647&(r=q(t))|0)>=1072010280&&(t<0&&(t=-t,e=-e),t=(h=.7853981633974483-t)+(l=3061616997868383e-32-e),e=0),a=e+(h=t*t)*((s=h*t)*((a=function(t){return 0===t?.13333333333320124:.13333333333320124+t*(.021869488294859542+t*(.0035920791075913124+t*(.0005880412408202641+t*(7817944429395571e-20+-18558637485527546e-21*t))))}(l=h*h))+(u=h*function(t){return 0===t?.05396825397622605:.05396825397622605+t*(.0088632398235993+t*(.0014562094543252903+t*(.0002464631348184699+t*(7140724913826082e-20+2590730518636337e-20*t))))}(l)))+e),l=t+(a+=.3333333333333341*s),o>=1072010280?(1-(r>>30&2))*((u=n)-2*(t-(l*l/(l+u)-a))):1===n?l:(Kt(h=l,0),u=a-(h-t),Kt(c=i=-1/l,0),c+i*((s=1+c*h)+c*u))},Zt=[0,0];void 0===window.CroquetMath&&(window.CroquetMath={}),window.CroquetMath.acos=function(t){var o;return e(t)||t<-1||t>1?NaN:t>.5?2*i(n(.5-.5*t)):(o=r-i(t),o+=6123233995736766e-32,o+=r)},window.CroquetMath.acosh=function(t){var r;return e(t)||t<1?NaN:1===t?0:t>=1<<28?z(t)+J:t>2?z(2*t-1/(t+n(t*t-1))):V((r=t-1)+n(2*r+r*r))},window.CroquetMath.asin=i,window.CroquetMath.asinh=function(t){var r,o,i;return e(t)||G(t)?t:(t<0&&(t=-t,r=!0),i=t<1/(1<<28)?t:t>1<<28?z(t)+J:t>2?z(2*t+1/(n(t*t+1)+t)):V(t+(o=t*t)/(1+n(1+o))),r?-i:i)},window.CroquetMath.atan=Q,window.CroquetMath.atanh=function(t){var n,r;return e(t)||t<-1||t>1?NaN:1===t?F:-1===t?U:(t<0&&(n=!0,t=-t),t<1/(1<<28)?n?-t:t:(r=t<.5?.5*V((r=t+t)+r*t/(1-t)):.5*V((t+t)/(1-t)),n?-r:r))},window.CroquetMath.atan2=function(t,n){var r;return e(n)||e(t)?NaN:G(n)?n===F?G(t)?dt(vt/4,t):dt(0,t):G(t)?dt(3*vt/4,t):dt(vt,t):G(t)?dt(vt/2,t):0===t?n>=0&&!function(t){return!!(q(t)>>>31)}(n)?dt(0,t):dt(vt,t):0===n?dt(vt/2,t):(r=Q(t/n),n<0?r<=0?r+vt:r-vt:r)},window.CroquetMath.cbrt=function(t){var n,r,o,i,a;return e(t)||G(t)||0===t?t:(r=-2147483648&(o=q(t)),o&=2147483647,a=0,t<22250738585072014e-324?(a=0x40000000000000,n=q(a*=t),a=ht(r|(n=(2147483647&n)/3+696219795),0)):a=B(a,r|(n=o/3+715094163)),a*=function(t){return 0===t?1.87595182427177:1.87595182427177+t*(t*(1.6214297201053545+t*(.14599619288661245*t-.758397934778766))-1.8849797954337717)}(i=a*a*(a/t)),n=q(a),a=ht(n+1,0),a+=a*(i=((i=t/(a*a))-a)/(a+a+i)))},window.CroquetMath.cos=function(t){var e;if(e=q(t),(e&=2147483647)<=1072243195)return e<1044381696?1:pt(t,0);if(e>=2146435072)return NaN;switch(3&$t(t,Vt)){case 0:return pt(Vt[0],Vt[1]);case 1:return-mt(Vt[0],Vt[1]);case 2:return-pt(Vt[0],Vt[1]);default:return mt(Vt[0],Vt[1])}},window.CroquetMath.cosh=function(t){return e(t)?t:(t<0&&(t=-t),t>21?Wt(t)/2:(Wt(t)+Wt(-t))/2)},window.CroquetMath.exp=Wt,window.CroquetMath.expm1=function(t){var n,r,o,i,a,s,c,u,l,h,f,d;if(t===F||e(t))return t;if(t===U)return-1;if(0===t)return t;if(t<0?(r=!0,c=-t):(r=!1,c=t),c>=38.816242111356935){if(r)return-1;if(c>=709.782712893384)return F}if(a=0|q(c),c>.34657359027997264)c<1.0397207708399179?r?(o=t+.6931471803691238,i=-1.9082149292705877e-10,d=-1):(o=t-.6931471803691238,i=1.9082149292705877e-10,d=1):(d=r?1.4426950408889634*t-.5:1.4426950408889634*t+.5,o=t-.6931471803691238*(h=d|=0),i=1.9082149292705877e-10*h),l=o-(t=o-i)-i;else{if(a<1016070144)return t;d=0}return f=(u=t*(n=.5*t))*(((s=1+u*function(t){return 0===t?-.03333333333333313:t*(.0015873015872548146+t*(t*(4008217827329362e-21+-2.0109921818362437e-7*t)-793650757867488e-19))-.03333333333333313}(u))-(h=3-s*n))/(6-t*h)),0===d?t-(t*f-u):(f=t*(f-l)-l,f-=u,-1===d?.5*(t-f)-.5:1===d?t<-.25?-2*(f-(t+.5)):1+2*(t-f):d<=-2||d>56?(o=q(c=1-(f-t))+(d<<20)|0,(c=B(c,o))-1):(h=1,d<20?c=(h=B(h,o=1072693248-(2097152>>d)|0))-(f-t):(c=t-(f+(h=B(h,o=1023-d<<20|0))),c+=1),o=q(c)+(d<<20)|0,B(c,o)))},window.CroquetMath.log=z,window.CroquetMath.log1p=V,window.CroquetMath.log10=function(t){var n,r,o,i,a,s,c;return e(t)||t<0?NaN:0===t?U:(a=0,(r=q(t))<1048576&&(a-=54,r=q(t*=0x40000000000000)),r>=2146435072?t+t:(a+=(r>>20)-1023|0,t=B(t,(r&=1048575)|1072693248^(i=r+614244&1048576|0)),s=a+=i>>20|0,o=function(t){var e,n,r,o,i,a,s,c,u,l;return o=t-1,(1048575&2+(r=q(t)))<3?0===o?0:o*o*(.3333333333333333*o-.5):(u=(r&=1048575)-398458|0,l=440401-r|0,n=(c=(a=(i=o/(2+o))*i)*a)*function(t){return 0===t?.3999999999940942:.3999999999940942+t*(.22222198432149784+.15313837699209373*t)}(c),s=a*function(t){return 0===t?.6666666666666735:.6666666666666735+t*(.2857142874366239+t*(.1818357216161805+.14798198605116586*t))}(c)+n,(u|=l)>0?i*((e=.5*o*o)+s)-e:i*(s-o))}(t),n=Kt(t-=1,0),c=3694239077158931e-28*s+25082946711645275e-27*(t+o),(c+=.4342944818781689*(t-n+o)+.4342944818781689*n)+.30102999566361177*s))},window.CroquetMath.log2=function(t){var n,r,o,i,a;if(e(t)||t<0)return NaN;if(it(Qt,t),a=0,(r=Qt[0])<1048576){if(0==(2147483647&r|Qt[1]))return U;a-=54,r=q(t*=0x40000000000000)}return r>=2146435072?t+t:(a+=(r>>20)-1023|0,t=B(t,(r&=1048575)|1072693248^(i=r+614244&1048576|0)),a+=i>>20|0,o=function(t){var e,n,r,o,i,a,s,c,u,l;return o=t-1,(1048575&2+(r=q(t)))<3?0===o?0:o*o*(.3333333333333333*o-.5):(u=(r&=1048575)-398458|0,l=440401-r|0,n=(c=(a=(i=o/(2+o))*i)*a)*function(t){return 0===t?.3999999999940942:.3999999999940942+t*(.22222198432149784+.15313837699209373*t)}(c),s=a*function(t){return 0===t?.6666666666666735:.6666666666666735+t*(.2857142874366239+t*(.1818357216161805+.14798198605116586*t))}(c)+n,(u|=l)>0?i*((e=.5*o*o)+s)-e:i*(s-o))}(t),n=Kt(t-=1,0),1.6751713164886512e-10*(t+o)+1.4426950407214463*(t-n+o)+1.4426950407214463*n+a)},window.CroquetMath.sin=function(t){var e;if(e=q(t),(e&=2147483647)<=1072243195)return e<1045430272?t:mt(t,0);if(e>=2146435072)return NaN;switch(3&$t(t,Yt)){case 0:return mt(Yt[0],Yt[1]);case 1:return pt(Yt[0],Yt[1]);case 2:return-mt(Yt[0],Yt[1]);default:return-pt(Yt[0],Yt[1])}},window.CroquetMath.sinh=function(t){var e;return 0===t?t:(e=kt(t),t>710.4758600739439||t<-709.089565712824?t>0?F:U:e>1?e>=709.0895657128241?(e=Wt(.5*e),e*=.5*e,t<0&&(e=-e),e):(e=.5*(e=Wt(e))-.5/e,t<0&&(e=-e),e):t+t*(e*=e)*function(t){var e,n;return 0===t?.16666666666666666:((t<0?-t:t)<=1?(e=t*(t*(-.789474443963537*t-163.72585752598383)-11561.443576500522)-351754.9648081514,n=t*(36157.827983443196+t*(1*t-277.7110814206028))-2110529.7888489086):(e=(t=1/t)*(t*(-351754.9648081514*t-11561.443576500522)-163.72585752598383)-.789474443963537,n=1+t*(t*(36157.827983443196+-2110529.7888489086*t)-277.7110814206028)),e/n)}(e))},window.CroquetMath.tan=function(t){var e,n;return e=q(t),(e&=2147483647)<=1072243195?e<1044381696?t:Xt(t,0,1):e>=2146435072?NaN:(n=$t(t,Zt),Xt(Zt[0],Zt[1],1-((1&n)<<1)))},window.CroquetMath.tanh=function(t){var e,n;if((n=kt(t))>44.014845965556525)return t<0?-1:1;if(n>=.625)n=1-2/((e=Wt(2*n))+1),t<0&&(n=-n);else{if(0===t)return t;n=t+t*(e=t*t)*function(t){var e,n;return 0===t?-.3333333333333332:((t<0?-t:t)<=1?(e=t*(t*(0*t-.9643991794250523)-99.28772310019185)-1614.6876844170845,n=4844.063053251255+t*(2235.4883906010045+t*(112.81167849163293+1*t))):(e=0+(t=1/t)*(t*(-1614.6876844170845*t-99.28772310019185)-.9643991794250523),n=1+t*(112.81167849163293+t*(2235.4883906010045+4844.063053251255*t))),e/n)}(e)}return n};var te=Math.pow;function ee(t){return t===1/0||t===-1/0}window.CroquetMath.pow=function(t,e){if(isNaN(t)||isNaN(e))return NaN;if(ee(t)||ee(e))return te(t,e);if(0===t||0===e)return te(t,e);if(t<0&&!function(t){return Number.isInteger(t)}(e))return NaN;if(1===e)return t;if(2===e)return t*t;if(3===e)return t*t*t;if(4===e)return t*t*t*t;var n=1;return t<0&&(t*=-1,n=te(-1,e)),window.CroquetMath.exp(window.CroquetMath.log(t)*e)*n}}();var ge=null,be={};function we(t,e){var n=JSON.parse(atob(t.slice(1,-1))),o=n.qPara,i=n.qArgs,a=n.qFn,s=JSON.stringify(o),c=be[s]||(be[s]=g(Function,r(o)));return"number"==typeof a&&(i[a]=c),c.call.apply(c,[e].concat(r(i))).bind(e)}function ke(t,e){if(ge)throw Error("Island confusion");if(!(t instanceof Se))throw Error("not an island: "+t);var n=ge;try{ge=t,window.ISLAND=t,e()}finally{ge=n}}var Se=function(){function t(e,n){var r=this;u(this,t),t.installCustomMath(),ke(this,(function(){fe(r,(function(){if(r.modelsById={},r.modelsByName={},r.messages=new ne((function(t,e){return t.before(e)})),r.subscriptions={},r.users={},r._random=function(){throw Error("You must not use random when applying state!")},r.id=e.id,r.time=0,r.seq=4294967280,r.externalTime=0,r.externalSeq=r.seq,r.futureSeq=0,r.tuttiSeq=0,r.lastSnapshotPoll=0,r.modelsId=0,e.modelsById)for(var t=Ie.newOrRecycled(r).readIsland(e,"$"),o=0,i=Object.keys(t);o<i.length;o++){var a=i[o];if(a in r||"meta"===a)if("messages"===a){var s,u=ye(t.messages);try{for(u.s();!(s=u.n()).done;){var l=s.value;r.messages.add(l)}}catch(t){u.e(t)}finally{u.f()}}else r[a]=t[a];else console.warn("Ignoring property snapshot.".concat(a))}else{r._random=new c(null,{state:!0});var h=n(r)||{};Object.assign(r.modelsByName,h),r.addSubscription(r,r.id,"__users__",r.generateJoinExit)}}))}))}return l(t,null,[{key:"current",value:function(){return ge||console.warn("No CurrentIsland!"),ge}},{key:"installCustomMath",value:function(){if(!window.BrowserMath){window.CroquetMath.random=function(){return ge.random()},window.BrowserMath={};for(var t=function(){var t=n(r[e],2),o=t[0],i=t[1],a=window.Math[o];window.BrowserMath[o]=a,window.Math[o]=["pow","atan2"].includes(o)?function(t,e){return ge?i(t,e):a(t,e)}:function(t){return ge?i(t):a(t)}},e=0,r=Object.entries(window.CroquetMath);e<r.length;e++)t()}}}]),l(t,[{key:"registerModel",value:function(t,e){if(ge!==this)throw Error("Island Error");return e||(e=this.id+"/M"+ ++this.modelsId),this.modelsById[e]=t,e}},{key:"deregisterModel",value:function(t){if(ge!==this)throw Error("Island Error");var e=this.modelsById;delete this.modelsById[t];for(var r=0,o=Object.entries(this.modelsByName);r<o.length;r++){var i=n(o[r],2),a=i[0];e===i[1]&&delete this.modelsByName[a]}this.messages.removeMany((function(e){return e.hasReceiver(t)}))}},{key:"lookUpModel",value:function(t){if(t===this.id)return this;var e=this.modelsById[t];if(e)return e;var r=t.match(/^([^#]+)#(.*)$/),o=n(r,3),i=(o[0],o[1]),a=o[2];return this.modelsById[i].lookUp(a)}},{key:"get",value:function(t){return this.modelsByName[t]}},{key:"set",value:function(t,e){if(ge!==this)throw Error("Island Error");this.modelsByName[t]=e}},{key:"getNextTuttiSeq",value:function(){return this.tuttiSeq=this.tuttiSeq+1>>>0,this.tuttiSeq}},{key:"callModelMethod",value:function(t,e,n){if(ge)throw Error("Island Error");var r=this.lookUpModel(t);if(r){var o=new _e(this.time,0,r.id,e,n);this.controller.sendMessage(o)}else console.error(Error("Model not found: ".concat(t)))}},{key:"noop",value:function(){}},{key:"generateJoinExit",value:function(t){var e,r=t.entered,o=t.exited,i=t.count,a=ye(o=r.length===i?Object.keys(this.users):o.map((function(t){return t[0]})));try{for(a.s();!(e=a.n()).done;){var s=e.value;this.users[s]&&(delete this.users[s],this.publishFromModel(this.id,"view-exit",s))}}catch(t){a.e(t)}finally{a.f()}var c,u=ye(r);try{for(u.s();!(c=u.n()).done;){var l=n(c.value,3),h=l[0],f=l[1],d=l[2];this.users[h]||(this.users[h]={name:f},d&&(this.users[h].location=d),this.publishFromModel(this.id,"view-join",h))}}catch(t){u.e(t)}finally{u.f()}}},{key:"scheduleExternalMessage",value:function(t){var e=_e.fromState(t,this);if(e.time<this.time)throw Error("past message from reflector "+t);var n=this.externalSeq+1>>>0;if(e.seq!==n)throw Error("External message error. Expected message #".concat(n," got #").concat(e.seq));return this.externalTime=e.time,this.externalSeq=e.seq,e.seq=2*e.seq+1,this.messages.add(e),e}},{key:"futureSend",value:function(t,e,n,r){if(t.every)return this.futureRepeat(t.every,e,n,r);if(t<0)throw Error("attempt to send future message into the past");this.futureSeq=this.futureSeq+1>>>0;var o=new _e(this.time+t,2*this.futureSeq,e,n,r);return this.messages.add(o),o}},{key:"futureRepeat",value:function(t,e,n,r){this.futureSend(t,this.id,"futureExecAndRepeat",[t,e,n,r])}},{key:"futureExecAndRepeat",value:function(t,e,n,o){var i=this.lookUpModel(e);if("function"==typeof i[n])try{i[n].apply(i,r(o))}catch(t){ct("future message ".concat(i,".").concat(n),t)}else{var a=we(n,i);try{a.apply(void 0,r(o))}catch(t){ct("future message ".concat(i," ").concat(a),t)}}this.futureRepeat(t,e,n,o)}},{key:"future",value:function(t,e,n,r){var o=this.asQFunc(t,n);if("string"==typeof o)return this.futureSend(e,t.id,o,r);var i=this;return new Proxy(t,{get:function(n,r){if("function"==typeof t[r])return function(){if(i.lookUpModel(t.id)!==t)throw Error("future send to unregistered model");for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return i.futureSend(e,t.id,r,o)};throw Error("Tried to call "+r+"() on future of "+Object.getPrototypeOf(t).constructor.name+" which is not a function")}})}},{key:"advanceTo",value:function(t,e){if(ge)throw Error("Island Error");for(var n,r=0;(n=this.messages.peek())&&n.time<=t;){var o=n,i=o.time,a=o.seq;if(i<this.time)throw Error("past message encountered: "+n);if(1&a&&(this.seq=this.seq+1>>>0,a/2>>>0!==this.seq))throw Error("Sequence error: expected ".concat(this.seq," got ").concat(a/2>>>0," in ").concat(n));if(this.messages.poll(),this.time=n.time,n.executeOn(this),++r>100&&(r=0,Date.now()>e))return!1}return this.time=t,!0}},{key:"asQFunc",value:function(t,e){if("string"==typeof e)return e;if("function"==typeof e){if(t[e.name]===e)return e.name;for(var r=t;null!==r;){for(var o=0,i=Object.entries(Object.getOwnPropertyDescriptors(r));o<i.length;o++){var a=n(i[o],2),s=a[0];if(a[1].value===e)return s}r=Object.getPrototypeOf(r)}var c=e.toString().match(/^\(?([a-z][a-z0-9]*)?\)? *=> *this\.([a-z][a-z0-9]*) *\( *([a-z][a-z0-9]*)? *\) *$/i);return!c||c[3]&&c[3]!==c[1]?function(t,e){"function"==typeof t&&(e=t,t={});var n=Object.keys(t).concat(["return "+e]),r=Object.values(t),o={qPara:n,qArgs:r},i=r.indexOf(e);return i>=0&&(r[i]=n[i],o.qFn=i),"{".concat(btoa(JSON.stringify(o)),"}")}(e):c[2]}return null}},{key:"addSubscription",value:function(t,e,n,r){if(ge!==this)throw Error("Island Error");var o=this.asQFunc(t,r);if("string"!=typeof o)throw Error('Subscription handler for "'.concat(n,'" must be a method name'));if("function"!=typeof t[o]&&"{"!==o[0])throw Error('Subscriber method for "'.concat(n,'" not found: ').concat(t,".").concat(o,"()"));var i=e+":"+n,a=t.id+"."+o;if(this.subscriptions[i]){if(-1!==this.subscriptions[i].indexOf(a))throw Error("".concat(t,".").concat(o," already subscribed to ").concat(n))}else this.subscriptions[i]=[];this.subscriptions[i].push(a)}},{key:"removeSubscription",value:function(t,e,n,r){if(ge!==this)throw Error("Island Error");var o=e+":"+n,i=t.id+"."+r,a=this.subscriptions[o];if(a){var s=a.indexOf(i);a.splice(s,1),0===a.length&&delete this.subscriptions[o]}}},{key:"removeAllSubscriptionsFor",value:function(t){for(var e="".concat(t.id,":"),r="".concat(t.id,"."),o=0,i=Object.entries(this.subscriptions);o<i.length;o++){var a=n(i[o],2),s=a[0],c=a[1];if(s.startsWith(e))delete this.subscriptions[s];else{for(var u=c.length-1;u>=0;u--)c[u].startsWith(r)&&c.splice(u,1);0===c.size&&delete this.subscriptions[s]}}}},{key:"publishFromModel",value:function(t,e,n){if(ge!==this)throw Error("Island Error");var r=e.endsWith("#reflected");r&&(e=e.slice(0,e.length-"#reflected".length));var o=t+":"+e;this.handleModelEventInModel(o,n,r),this.handleModelEventInView(o,n)}},{key:"publishFromView",value:function(t,e,n){if(ge)throw Error("Island Error");var r=t+":"+e;this.handleViewEventInModel(r,n),this.handleViewEventInView(r,n)}},{key:"handleModelEventInModel",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(ge!==this)throw Error("Island Error");if(n){var r=this.getNextTuttiSeq();if(!0!==this.controller.synced)return;var o=t+"#__vote",i=t+"#divergence",a=!!ae.subscriptions[o],s=!!this.subscriptions[t],c=!!this.subscriptions[i];a&&c&&console.log("divergence subscription for ".concat(t," overridden by vote subscription"));var u,l=s?new _e(this.time,0,this.id,"handleModelEventInModel",[t,e]):null;u=a?[this.id,"handleModelEventInView",o]:[this.id,"handleTuttiDivergence",i],this.controller.sendTutti(this.time,r,e,l,a,u)}else if(this.subscriptions[t]){var h,f=ye(this.subscriptions[t]);try{for(f.s();!(h=f.n()).done;){var d=h.value,v=d.split("."),p=m(v),y=p[0],g=p.slice(1),b=g.join("."),w=this.lookUpModel(y);if(w){if("{"===b[0]){var k=we(b,w);try{k(e)}catch(e){ct("event ".concat(t," ").concat(w," ").concat(k),e)}continue}"function"!=typeof w[b]&&at("event ".concat(t," ").concat(w,".").concat(b,"(): method not found"))}else at("event ".concat(t," .").concat(b,"(): subscriber not found"));try{w[b](e)}catch(e){ct("event ".concat(t," ").concat(w,".").concat(b,"()"),e)}}}catch(t){f.e(t)}finally{f.f()}}}},{key:"handleViewEventInModel",value:function(t,e){if(this.subscriptions[t]){var n=new _e(this.time,0,this.id,"handleModelEventInModel",[t,e]);this.controller.sendMessage(n)}}},{key:"handleModelEventInView",value:function(t,e){var n=this;ae.handleEvent(t,e,(function(t){return function(t){if(!ge)throw Error("Island confusion");var e=ge;try{ge=null,t()}finally{ge=e}}((function(){return de(n,t,!0)}))}))}},{key:"handleViewEventInView",value:function(t,e){ae.handleEvent(t,e)}},{key:"handleTuttiDivergence",value:function(t,e){if(this.subscriptions[t])this.handleModelEventInModel(t,e);else{var n=t.split(":").slice(-1)[0];console.warn("uncaptured divergence in ".concat(n,":"),e)}}},{key:"processModelViewEvents",value:function(){var t=this;if(ge)throw Error("Island Error");return de(this,(function(){return ae.processFrameEvents(!!t.controller.synced)}))}},{key:"pollToCheckSync",value:function(){var t=this.getNextTuttiSeq();if(!0===this.controller.synced){var e=Date.now(),n={date_island:this.time,hash:this.getSummaryHash()},r=Date.now()-e;this.controller.cpuTime-=r;var o=[this.id,"handleSyncCheckVote","syncCheckVote"];this.controller.sendTutti(this.time,t,n,null,!0,o)}}},{key:"handleSyncCheckVote",value:function(t,e){this.controller.handleSyncCheckVote(e)}},{key:"pollForSnapshot",value:function(){var t=this,e=this.getNextTuttiSeq(),n=this.time,r=n-this.lastSnapshotPoll;if(r<5e3)console.log("rejecting snapshot poll ".concat(r,"ms after previous"));else{this.lastSnapshotPoll=n;var o=this.controller.preparePollForSnapshot();if(o){var i=Date.now();o.hash=this.getSummaryHash();var a=Date.now()-i;this.controller.cpuTime-=a,Promise.resolve().then((function(){return t.controller.pollForSnapshot(n,e,o)}))}}}},{key:"handleSnapshotVote",value:function(t,e){this.controller.handleSnapshotVote(e)}},{key:"snapshot",value:function(){return Me.newOrRecycled(this).snapshot(this,"$")}},{key:"getSummaryHash",value:function(){return(new Ae).getHash(this)}},{key:"random",value:function(){if(ge!==this)throw Error("Island Error");return this._random()}},{key:"randomID",value:function(){if(ge!==this)throw Error("Island Error");for(var t="",e=0;e<4;e++)t+=(this._random.int32()>>>0).toString(16).padStart(8,"0");return t}}]),t}();function xe(t,e){var r=t.match(/^([^[]+)(\[.*)?$/i),o=n(r,3),i=(o[0],o[1]),a=o[2],s=i.split(">"),c=n(s,2),u=c[0],l=c[1],h=[];a&&(h=qe.newOrRecycled(e).decode(JSON.parse(a)));return{receiver:u,selector:l,args:h}}function Ce(t,e){return(e-t|0)>=0}var Ee,Oe,_e=function(){function t(e,n,r,o,i){u(this,t),this.time=e,this.seq=n,this.payload=function(t,e,n){return n.length>0&&(n=je.newOrRecycled().encode(n)),"".concat(t,">").concat(e).concat(n.length>0?JSON.stringify(n):"")}(r,o,i)}return l(t,[{key:"before",value:function(t){return this.time!==t.time?this.time<t.time:this.isExternal()!==t.isExternal()?t.isExternal():this.isExternal()?Ce(this.externalSeq,t.externalSeq):Ce(this.internalSeq,t.internalSeq)}},{key:"hasReceiver",value:function(t){return function(t,e){return t.startsWith("".concat(e,">"))}(this.payload,t)}},{key:"isExternal",value:function(){return 1&this.seq}},{key:"asState",value:function(){return[this.time,this.seq,this.payload]}},{key:"executeOn",value:function(t){var e=this,n=xe(this.payload,t),o=n.receiver,i=n.selector,a=n.args,s=t.lookUpModel(o);if(s)if("{"===i[0]){var c=we(i,s);ke(t,(function(){fe(t,(function(){try{c.apply(void 0,r(a))}catch(t){ct("".concat(e.shortString()," ").concat(c),t)}}))}))}else"function"!=typeof s[i]?at("".concat(this.shortString()," ").concat(s,".").concat(i,"(): method not found")):ke(t,(function(){fe(t,(function(){try{s[i].apply(s,r(a))}catch(t){ct("".concat(e.shortString()," ").concat(s,".").concat(i,"()"),t)}}))}));else at("".concat(this.shortString()," ").concat(i,"(): receiver not found"))}},{key:"shortString",value:function(){return"".concat(this.isExternal()?"External":"Future","Message")}},{key:"toString",value:function(){var t=xe(this.payload),e=t.receiver,n=t.selector,r=t.args,o=this.isExternal(),i=o?this.externalSeq:this.internalSeq;return"".concat(o?"External":"Future","Message[").concat(this.time).concat(":#"[+o]).concat(i," ").concat(e,".").concat(n,"(").concat(r.map(JSON.stringify).join(", "),")]")}},{key:Symbol.toPrimitive,value:function(){return this.toString()}},{key:"externalSeq",get:function(){return this.seq/2>>>0},set:function(t){this.seq=2*t+1}},{key:"internalSeq",get:function(){return this.seq/2>>>0},set:function(t){this.seq=2*t}}],[{key:"fromState",value:function(e,r){var o=n(e,3),i=o[0],a=o[1],s=xe(o[2],r);return new t(i,a,s.receiver,s.selector,s.args)}}]),t}(),Te=(Ee=new ArrayBuffer(8),Oe=new DataView(Ee),function(t){return Oe.setFloat64(0,t,!0),Oe.getInt32(0,!0)+Oe.getInt32(4,!0)}),Ae=function(){function t(){u(this,t),this.refs=new Map,this.todo=[],this.hashers=new Map,this.addHasher("Teatime:Message",_e);var e,r=ye(Fe.allClassTypes());try{for(r.s();!(e=r.n()).done;){var o=n(e.value,2),i=o[0],a=o[1];this.addHasher(i,a)}}catch(t){r.e(t)}finally{r.f()}}return l(t,[{key:"addHasher",value:function(t,e){var n=this,r=Object.getPrototypeOf(e)===Object.prototype?e:{cls:e,write:function(t){return Object.assign({},t)}},o=r.cls,i=r.write;this.hashers.set(o,(function(t){return n.hashStructure(t,i(t))}))}},{key:"getHash",value:function(t){this.hashState={oC:0,mC:0,nanC:0,infC:0,zC:0,nC:0,nH:0,sC:0,sL:0,fC:0};for(var e=0,r=Object.entries(t);e<r.length;e++){var o=n(r[e],2),i=o[0],a=o[1];if("controller"!==i&&"meta"!==i)if("_random"===i)this.hash(a.state(),!1);else if("messages"===i){var s=a.asArray();(this.hashState.fC=s.length)&&this.hash(s,!1)}else this.hashEntry(i,a)}return this.hashDeferred(),this.hashState}},{key:"hashDeferred",value:function(){for(;this.todo.length>0;){var t=this.todo.shift(),e=t.key,n=t.value;this.hashEntry(e,n,!1)}}},{key:"hash",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];switch(o(t)){case"number":return void(Number.isNaN(t)?this.hashState.nanC++:Number.isFinite(t)?0===t?this.hashState.zC++:(this.hashState.nC++,this.hashState.nH+=Te(t)):this.hashState.infC++);case"string":return this.hashState.sC++,void(this.hashState.sL+=t.length);case"boolean":case"undefined":return;default:var n=Object.prototype.toString.call(t).slice(8,-1);switch(n){case"Array":return void this.hashArray(t,e);case"Set":case"Map":case"Uint8Array":case"Uint16Array":case"Float32Array":return void this.hashStructure(t,r(t));case"Object":if(t instanceof Fe)this.hashModel(t);else if(t.constructor===Object)this.hashObject(t,e);else{var i=this.hashers.get(t.constructor);if(!i)throw Error("Don't know how to hash ".concat(t.constructor.name));i(t)}return;case"Null":return;default:throw Error("Don't know how to hash ".concat(n))}}}},{key:"hashModel",value:function(t){if(!this.refs.has(t)){this.hashState.mC++,this.refs.set(t,!0);for(var e=0,r=Object.entries(t);e<r.length;e++){var o=n(r[e],2),i=o[0],a=o[1];"__realm"!==i&&(void 0!==a&&this.hashEntry(i,a))}}}},{key:"hashObject",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.refs.has(t)){this.hashState.oC++,this.refs.set(t,!0);for(var r=0,o=Object.entries(t);r<o.length;r++){var i=n(o[r],2),a=i[0],s=i[1];void 0!==s&&this.hashEntry(a,s,e)}}}},{key:"hashArray",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.refs.has(t)){this.refs.set(t,!0);for(var n=0;n<t.length;n++)this.hashEntry(n,t[n],e)}}},{key:"hashStructure",value:function(t,e){void 0!==e&&(this.refs.has(t)||(this.refs.set(t,!0),this.hash(e,!1)))}},{key:"hashEntry",value:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];"$"!==t[0]?n&&"object"===o(e)?this.todo.push({key:t,value:e}):this.hash(e):at("snapshot: ignoring property ".concat(t),{only:"once"})}}]),t}(),Me=function(){function t(e){u(this,t),this.island=e,this.nextRef=1,this.refs=new Map,this.todo=[],this.writers=new Map,this.addWriter("Teatime:Message",_e);var r,o=ye(Fe.allClassTypes());try{for(o.s();!(r=o.n()).done;){var i=n(r.value,2),a=i[0],s=i[1];this.addWriter(a,s)}}catch(t){o.e(t)}finally{o.f()}}return l(t,null,[{key:"newOrRecycled",value:function(t){var e=this.reusableInstance;return e?(e.island=t,e.nextRef=1,e.refs=new Map,e.todo=[]):e=this.reusableInstance=new this(t),e}},{key:"resetInstance",value:function(){this.reusableInstance=null}},{key:"reusableInstance",get:function(){return this[this.name+"-instance"]},set:function(t){this[this.name+"-instance"]=t}}]),l(t,[{key:"addWriter",value:function(t,e){var n=this,r=Object.getPrototypeOf(e)===Object.prototype?e:{cls:e,write:function(t){return Object.assign({},t)}},o=r.cls,i=r.write;this.writers.set(o,(function(e,r){return n.writeAs(t,e,i(e),r)}))}},{key:"snapshot",value:function(t){for(var e={_random:t._random.state(),messages:this.write(t.messages.asArray())},r=0,o=Object.entries(t);r<o.length;r++){var i=n(o[r],2),a=i[0],s=i[1];"controller"!==a&&(e[a]||this.writeInto(e,a,s,"$"))}return this.writeDeferred(),e}},{key:"writeDeferred",value:function(){for(;this.todo.length>0;){var t=this.todo.shift(),e=t.state,n=t.key,r=t.value,o=t.path;this.writeInto(e,n,r,o,!1)}}},{key:"write",value:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];switch(o(t)){case"number":return Number.isSafeInteger(t)?t:Number.isNaN(t)?{$class:"NaN"}:Number.isFinite(t)?this.writeFloat(t):{$class:"Infinity",$value:Math.sign(t)};case"string":case"boolean":case"undefined":return t;default:var i=Object.prototype.toString.call(t).slice(8,-1);switch(i){case"Array":return this.writeArray(t,e,n);case"Set":case"Map":case"Uint8Array":case"Uint16Array":case"Float32Array":return this.writeAs(i,t,r(t),e);case"Object":if(t instanceof Fe)return this.writeModel(t,e);if(t.constructor===Object)return this.writeObject(t,e,n);var a=this.writers.get(t.constructor);if(a)return a(t,e);throw Error("Don't know how to write ".concat(t.constructor.name," at ").concat(e));case"Null":return t;default:throw Error("Don't know how to write ".concat(i," at ").concat(e))}}}},{key:"writeModel",value:function(t,e){if(this.refs.has(t))return this.writeRef(t);var n={$model:Fe.classToID(t.constructor)};this.refs.set(t,n);var r,o=ye(Object.keys(t).sort());try{for(o.s();!(r=o.n()).done;){var i=r.value;if("__realm"!==i){var a=t[i];void 0!==a&&this.writeInto(n,i,a,e)}}}catch(t){o.e(t)}finally{o.f()}return n}},{key:"writeObject",value:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this.refs.has(t))return this.writeRef(t);var r={};this.refs.set(t,r);var o,i=ye(Object.keys(t).sort());try{for(i.s();!(o=i.n()).done;){var a=o.value,s=t[a];void 0!==s&&this.writeInto(r,a,s,e,n)}}catch(t){i.e(t)}finally{i.f()}return r}},{key:"writeArray",value:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this.refs.has(t))return this.writeRef(t);var r=[];this.refs.set(t,r);for(var o=0;o<t.length;o++)this.writeInto(r,o,t[o],e,n);return r}},{key:"writeFloat",value:function(t){return t}},{key:"writeAs",value:function(t,e,n,r){if(void 0===n)return n;if(this.refs.has(e))return this.writeRef(e);var i={$class:t};this.refs.set(e,i);var a=this.write(n,r,!1);return"object"!==o(a)||Array.isArray(a)?i.$value=a:Object.assign(i,a),i}},{key:"writeRef",value:function(t){var e=this.refs.get(t);if("object"!==o(e))throw Error("Non-object in refs: "+t);return Array.isArray(e)&&(e.toJSON=function(){return{$id:this.$id,$class:"Array",$value:r(this)}}),{$ref:e.$id||(e.$id=this.nextRef++)}}},{key:"writeInto",value:function(t,e,n,r){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if("$"!==e[0])if(i&&"object"===o(n))this.todo.push({state:t,key:e,value:n,path:r});else{var a="string"==typeof e&&e.match(/^[_a-z][_a-z0-9]*$/i),s=r+(a?".".concat(e):"[".concat(JSON.stringify(e),"]")),c=this.write(n,s);void 0!==c&&(t[e]=c)}else at("snapshot: ignoring property ".concat(e),{only:"once"})}}]),t}(),Ie=function(){function t(e){u(this,t),this.island=e,this.refs=new Map,this.todo=[],this.unresolved=[],this.readers=new Map,this.addReader("Teatime:Message",_e);var r,o=ye(Fe.allClassTypes());try{for(o.s();!(r=o.n()).done;){var i=n(r.value,2),a=i[0],s=i[1];this.addReader(a,s)}}catch(t){o.e(t)}finally{o.f()}this.readers.set("NaN",(function(){return NaN})),this.readers.set("Infinity",(function(t){return t*(1/0)})),this.readers.set("Set",(function(t){return new Set(t)})),this.readers.set("Map",(function(t){return new Map(t)})),this.readers.set("Array",(function(t){return t.slice(0)})),this.readers.set("Uint8Array",(function(t){return new Uint8Array(t)})),this.readers.set("Uint16Array",(function(t){return new Uint16Array(t)})),this.readers.set("Float32Array",(function(t){return new Float32Array(t)}))}return l(t,null,[{key:"newOrRecycled",value:function(t){var e=this.reusableInstance;return e?(e.island=t,e.refs=new Map,e.todo=[],e.unresolved=[]):e=this.reusableInstance=new this(t),e}},{key:"resetInstance",value:function(){this.reusableInstance=null}},{key:"reusableInstance",get:function(){return this[this.name+"-instance"]},set:function(t){this[this.name+"-instance"]=t}}]),l(t,[{key:"addReader",value:function(t,e){var n="object"===o(e)?e.read:function(t){return Object.assign(Object.create(e.prototype),t)};this.readers.set(t,n)}},{key:"readIsland",value:function(t,e){if("$"!==e)throw Error("Island must be root object");for(var r={_random:new c(null,{state:t._random})},o=0,i=Object.entries(t);o<i.length;o++){var a=n(i[o],2),s=a[0],u=a[1];r[s]||this.readInto(r,s,u,e)}return this.readDeferred(),this.resolveRefs(),r}},{key:"readDeferred",value:function(){for(;this.todo.length>0;){var t=this.todo.shift(),e=t.object,n=t.key,r=t.value,o=t.path;this.readInto(e,n,r,o,1)}}},{key:"resolveRefs",value:function(){var t,e=ye(this.unresolved);try{for(e.s();!(t=e.n()).done;){var n=t.value,r=n.object,o=n.key,i=n.ref,a=n.path;if(!this.refs.has(i))throw Error("Unresolved ref: ".concat(i," at ").concat(a,"[").concat(JSON.stringify(o),"]"));r[o]=this.refs.get(i)}}catch(t){e.e(t)}finally{e.f()}}},{key:"read",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;switch(o(t)){case"number":case"string":case"boolean":return t;default:var r=Object.prototype.toString.call(t).slice(8,-1);switch(r){case"Array":return this.readArray(t,e,n);case"Null":return null;case"Object":var i=t.$class,a=t.$model,s=t.$ref;if(s)throw Error("refs should have been handled in readInto()");return a?this.readModel(t,e):i?this.readAs(i,t,e):this.readObject(Object,t,e,n);default:throw Error("Don't know how to read ".concat(r," at ").concat(e))}}}},{key:"readModel",value:function(t,e){var r=Fe.instantiateClassID(t.$model,t.id);t.$id&&this.refs.set(t.$id,r);for(var o=0,i=Object.entries(t);o<i.length;o++){var a=n(i[o],2),s=a[0],c=a[1];"id"!==s&&"$"!==s[0]&&this.readInto(r,s,c,e)}return r}},{key:"readObject",value:function(t,e,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=new t;e.$id&&this.refs.set(e.$id,i);for(var a=0,s=Object.entries(e);a<s.length;a++){var c=n(s[a],2),u=c[0],l=c[1];"$"!==u[0]&&this.readInto(i,u,l,r,o)}return i}},{key:"readArray",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=[];t.$id&&this.refs.set(t.$id,r);for(var o=0;o<t.length;o++)void 0!==t[o]&&this.readInto(r,o,t[o],e,n);return r}},{key:"readAs",value:function(t,e,r){var o={},i=new Map;if("$value"in e)o=this.read(e.$value,r,2);else for(var a=0,s=Object.entries(e);a<s.length;a++){var c=n(s[a],2),u=c[0],l=c[1];if("$"!==u[0]){var h=l&&l.$ref;h?this.refs.has(h)?o[u]=this.refs.get(h):(o[u]="<unresolved>",i.set(h,u)):this.readInto(o,u,l,r,1)}}var f=this.readers.get(t)(o,r);f||"NaN"===t||console.warn('Reading "'.concat(t,'" returned ').concat(f," at ").concat(r)),e.$id&&this.refs.set(e.$id,f);var d,v=ye(i.entries());try{for(v.s();!(d=v.n()).done;){var p=n(d.value,2),y=p[0],m=p[1];this.unresolved.push({object:f,key:m,ref:y,path:r})}}catch(t){v.e(t)}finally{v.f()}return f}},{key:"readRef",value:function(t,e,n,r){if(!n||!n.$ref)return!1;var o=n.$ref;return this.refs.has(o)?t[e]=this.refs.get(o):(t[e]="<unresolved>",this.unresolved.push({object:t,key:e,ref:o,path:r})),!0}},{key:"readInto",value:function(t,e,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(!this.readRef(t,e,n,r))if(0!==i||"object"!==o(n)){var a="string"==typeof e&&e.match(/^[_a-z][_a-z0-9]*$/i),s=r+(a?".".concat(e):"[".concat(JSON.stringify(e),"]"));t[e]=this.read(n,s,i>0?i-1:0)}else this.todo.push({object:t,key:e,value:n,path:r})}}]),t}(),je=function(t){d(n,Me);var e=ve(n);function n(){return u(this,n),e.apply(this,arguments)}return l(n,[{key:"encode",value:function(t){var e=this.writeArray(t,"$");return this.writeDeferred(),e}},{key:"writeModel",value:function(t){return{$ref:t.id}}}]),n}(),qe=function(t){d(n,Ie);var e=ve(n);function n(){return u(this,n),e.apply(this,arguments)}return l(n,[{key:"decode",value:function(t){var e=this.readArray(t,"$");return this.readDeferred(),this.resolveRefs(),e}},{key:"resolveRefs",value:function(){var t,e=ye(this.unresolved);try{for(e.s();!(t=e.n()).done;){var n=t.value,r=n.object,o=n.key,i=n.ref,a=n.path;if(this.refs.has(i))r[o]=this.refs.get(i);else{var s=this.island.lookUpModel(i);if(!s)throw Error("Unresolved ref: ".concat(i," at ").concat(a,"[").concat(JSON.stringify(o),"]"));r[o]=s}}}catch(t){e.e(t)}finally{e.f()}}}]),n}();function Ne(){Ie.resetInstance(),Me.resetInstance(),je.resetInstance(),qe.resetInstance()}function Pe(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return De(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return De(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,i=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function De(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var Re=I.has("debug","classes",!1),Le=Symbol("SECRET"),Be=new WeakSet,Fe=function(){function t(e){if(u(this,t),e!==Le)throw Error("You must create ".concat(this,' using create() not "new"!'))}return l(t,null,[{key:"__isTeatimeModelClass__",value:function(){return!0}},{key:"create",value:function(e,n){var r=he(),o=new this(Le);return Object.defineProperty(o,"__realm",{value:r}),Object.defineProperty(o,"id",{value:r.register(o),enumerable:!0}),Be.add(o),n&&o.beWellKnownAs(n),o.init(e),Be.has(o)&&(Be.delete(o),Object.getPrototypeOf(this)!==t&&console.warn("".concat(o," did not call super.init(options)"))),o}},{key:"createNoInit",value:function(t){var e=he(),n=new this(Le);return Object.defineProperty(n,"__realm",{value:e}),Object.defineProperty(n,"id",{value:t,enumerable:!0}),n}},{key:"allowConstructors",value:function(){Le=void 0,console.warn("disabling error reporting for Model constructors")}},{key:"register",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"unknown-file";return Ne(),Kt(this),ze(t,this.name,this),this}},{key:"registerIfNeeded",value:function(){Je(this)||this.register()}},{key:"types",value:function(){return{}}},{key:"classToID",value:function(t){return function(t){if(Je(t))return t[He];if($e(),Je(t))return t[He];throw Error('Class "'.concat(t.name,'" not found, did you call ').concat(t.name,".register()?"))}(t)}},{key:"classFromID",value:function(t){return We(t)}},{key:"allClasses",value:function(){return Ve()}},{key:"allClassTypes",value:function(){return function(){var t,e={},n=Pe(Ve());try{for(n.s();!(t=n.n()).done;){var r=t.value;Object.prototype.hasOwnProperty.call(r,"types")&&Object.assign(e,r.types())}}catch(t){n.e(t)}finally{n.f()}return Object.entries(e)}()}},{key:"instantiateClassID",value:function(t,e){return We(t).createNoInit(e)}}]),l(t,[{key:"init",value:function(t){Be.delete(this)}},{key:"destroy",value:function(){he().unsubscribeAll(this),he().deregister(this)}},{key:"publish",value:function(t,e,n){this.__realm||this.__realmError(),this.__realm.publish(e,n,t)}},{key:"subscribe",value:function(t,e,n){return this.__realm||this.__realmError(),this.__realm.subscribe(this,t,e,n)}},{key:"unsubscribe",value:function(t,e){this.__realm||this.__realmError(),this.__realm.unsubscribe(this,t,e)}},{key:"unsubscribeAll",value:function(){this.__realm||this.__realmError(),this.__realm.unsubscribeAll(this)}},{key:"__realmError",value:function(){if(!this.id)throw Error("".concat(this," has no ID, did you call super.init(options)?"))}},{key:"future",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1?arguments[1]:void 0;this.__realm||this.__realmError();for(var n=arguments.length,r=new Array(n>2?n-2:0),o=2;o<n;o++)r[o-2]=arguments[o];return this.__realm.future(this,t,e,r)}},{key:"random",value:function(){return he().random()}},{key:"now",value:function(){return he().now()}},{key:"beWellKnownAs",value:function(t){he().island.set(t,this)}},{key:"wellKnownModel",value:function(t){return this.__realm.island.get(t)}},{key:"modelOnly",value:function(t){var e="none";try{e=he()}catch(t){}if(e===this.__realm)return!0;var n=Error(t||"".concat(this,".modelOnly() called from outside a model!"));throw ct("view code",n),n}},{key:Symbol.toPrimitive,value:function(){var t=this.constructor.name;return t.includes("Model")?t:"".concat(t,"[Model]")}},{key:"sessionId",get:function(){return this.__realm.island.id}}]),t}(),Ue={},He=Symbol("CLASS_ID");function $e(){if(module.bundle)for(var t=0,e=Object.entries(module.bundle.cache);t<e.length;t++)for(var r=n(e[t],2),o=r[0],i=r[1],a=0,s=Object.entries(i.exports);a<s.length;a++){var c=n(s[a],2),u=c[0],l=c[1];l&&l.__isTeatimeModelClass__&&ze(o,"default"===u?l.name:u,l)}}function Ve(){return 0===Object.keys(Ue).length&&$e(),Object.values(Ue).map((function(t){return t.cls}))}function Je(t){return Object.prototype.hasOwnProperty.call(t,He)}function We(t){if(Ue[t])return Ue[t].cls;if($e(),Ue[t])return Ue[t].cls;throw Error('Class "'.concat(t,'" in snapshot, but not found in current source?'))}function ze(t,e,n){var r="".concat(t,":").concat(e),o=Ue[r];if(o&&o.cls!==n)throw Error("Duplicate class ".concat(e," in ").concat(t));return Je(n)?Re&&!o&&console.warn("ignoring re-exported class ".concat(e," from ").concat(t)):(Re&&console.log("registering class ".concat(e," from ").concat(t)),n[He]=r),Ue[r]={cls:n,file:t},n}var Ge=function(){function t(e){u(this,t),Object.defineProperty(this,"realm",{value:he()}),Object.defineProperty(this,"id",{value:this.realm.register(this),configurable:!0})}return l(t,null,[{key:"displayStatus",value:function(t,e){return st(t,e)}},{key:"displayWarning",value:function(t,e){return at(t,e)}},{key:"displayError",value:function(t,e){return it(t,e)}}]),l(t,[{key:"detach",value:function(){this.unsubscribeAll(),this.realm.deregister(this),Object.defineProperty(this,"id",{value:""})}},{key:"reattach",value:function(){Object.defineProperty(this,"id",{value:this.realm.register(this)})}},{key:"publish",value:function(t,e,n){this.realm.publish(e,n,t)}},{key:"subscribe",value:function(t,e,n){n=n.bind(this);var r=e.event?e:{event:e},o=r.event,i=r.handling;this.realm.subscribe(o,this.id,n,t,i)}},{key:"unsubscribe",value:function(t,e){this.realm.unsubscribe(e,this.id,null,t)}},{key:"unsubscribeAll",value:function(){this.realm.unsubscribeAll(this.id)}},{key:"future",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.realm.future(this,t)}},{key:"random",value:function(){return he().random()}},{key:"now",value:function(){return this.realm.now()}},{key:"externalNow",value:function(){return this.realm.externalNow()}},{key:"update",value:function(t){}},{key:"wellKnownModel",value:function(t){return this.realm.island.get(t)}},{key:"inSameViewRealm",value:function(t){return de(this.realm.island,t,!0)}},{key:Symbol.toPrimitive,value:function(){var t=this.constructor.name;return t.includes("View")?t:"".concat(t,"[View]")}},{key:"sessionId",get:function(){return this.realm.island.id}},{key:"viewId",get:function(){return this.realm.island.controller.viewId}}]),t}();function Ke(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return Qe(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Qe(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,i=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw o}}}}function Qe(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function Ye(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function Xe(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Ye(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ye(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var Ze=require("pako"),tn=w;console.log("Croquet SDK "+tn);var en=window.location.hostname.endsWith("croquet.io")?"".concat(window.location.host,"/reflector"):"croquet.io/reflector",nn="wss://".concat(en,"/v").concat(1),rn=null;var on=I.nocheat,an=["tps"];function sn(){return Math.floor(Math.random()*Math.pow(2,53)).toString(36)}var cn=new Set,un=function(){function t(){u(this,t),this.reset()}var a,s,c,f,d,v,p,y;return l(t,[{key:"reset",value:function(){this.island=null,this.connection=this.connection||new ln(this),this.networkQueue=new te,this.time=0,this.fastForwardTo=-1,this.session="",this.viewId=this.viewId||sn(),this.users=0,this.usersTotal=0,this.cpuTime=0,this.triggeringCpuTime=null,this.synced=null,this.latency=0,this.latencyHistory&&(this.latencyHistory=[]),this.localTicker&&(window.clearInterval(this.localTicker),delete this.localTicker),this.syncTimer&&(window.clearTimeout(this.syncTimer),delete this.syncTimer),this.tuttiHistory=[],ae.removeAllSubscriptionsFor(this.viewId),ae.addSubscription(this.viewId,"__users__",this.viewId,(function(t){return st("users now ".concat(t.count))}),"oncePerFrameWhileSynced"),wt.showSyncWait(!0)}},{key:"checkForConnection",value:function(t){this.connection.checkForConnection(t)}},{key:"dormantDisconnect",value:function(){this.connected&&this.connection.dormantDisconnect()}},{key:"establishSession",value:(y=i(e.mark((function t(i,a){var s,c,u,l,f,d,v,p,y,m,g,b,w,k,S,x,C,E,O;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(rn={messages:I.has("debug","messages",!1),sends:I.has("debug","sends",!1),ticks:I.has("debug","ticks",!1),pong:I.has("debug","pong",!1),snapshot:I.has("debug","snapshot",!1),session:I.has("debug","session",!1),initsnapshot:I.has("debug","initsnapshot","localhost"),reflector:I.has("debug","reflector",I.dev||"localhost")},s=a.optionsFromUrl,c=a.multiRoom,u=a.autoSession,l=a.login,f=Xe({},a.options),d=0,v=[].concat(an,r(s||[]));d<v.length;d++)(p=v[d])in I&&(f[p]=I[p]);if(!l){t.next=7;break}return t.next=7,St();case 7:return u&&(y=i,m=I.getSession().split("/"),g=c?m[1]:m[0],b=c?m[2]:m[1],(w=!g||!b)&&(u.user&&(g=u.user),u.random&&(b=u.random),g||(g=kt("name","").toLowerCase()||"GUEST"),b||(b=sn())),this.session=c?"".concat(y,"/").concat(g,"/").concat(b):"".concat(g,"/").concat(b),c||(I.setSession(this.session,w),wt.sessionURL=window.location.href),i="".concat(y,"/").concat(g,"/").concat(b)),k=function(t){return"object"===o(t)?h(t):t},S=Object.keys(f).length?i+"?"+Object.entries(f).map((function(t){var e=n(t,2),r=e[0],o=e[1];return"".concat(r,"=").concat(k(o))})).sort().join("&"):i,t.next=12,Qt(S,tn);case 12:return x=t.sent,C=x.hash,E=x.codeHash,console.log('Session ID for "'.concat(i,'": ').concat(C)),this.islandCreator=Xe({},a,{options:f,name:i,codeHash:E}),O=!1,this.islandCreator.snapshot?this.islandCreator.snapshot.id!==C&&(console.warn("Existing snapshot was for different code base!"),O=!0):O=!0,O&&(this.islandCreator.snapshot={id:C,time:0,meta:{id:C,codeHash:E,created:(new Date).toISOString()}}),t.next=22,this.join();case 22:return t.next=24,this.startedOrSynced();case 24:return t.abrupt("return",this.island.modelsByName);case 25:case"end":return t.stop()}}),t,this)}))),function(t,e){return y.apply(this,arguments)})},{key:"lastKnownTime",value:function(t){return Math.max(t.time,t.externalTime)}},{key:"handleSyncCheckVote",value:function(t){if(!0===this.synced){var e=t._local,n=t.tally,r=Object.keys(n);e&&r.includes(e)?r.length>1?console.log(r):console.log("ok"):console.log(this.id,"Sync: local vote not found",e,n)}}},{key:"takeSnapshot",value:function(){var t=this.island.snapshot(),e=this.lastKnownTime(t),n=t.externalSeq;return t.meta=Xe({},this.islandCreator.snapshot.meta,{options:this.islandCreator.options,time:e,seq:n,date:(new Date).toISOString(),host:window.location.hostname,sdk:tn}),delete t.meta.hash,t}},{key:"scheduleSnapshot",value:function(){if(this.island){var t=this.island.time,e=t-this.island.lastSnapshotPoll;if(e<5e3)rn.snapshot&&console.log("not requesting snapshot poll (".concat(e,"ms since poll scheduled)"));else{var n=new _e(t,0,this.island.id,"pollForSnapshot",[]);this.sendTagged(n,{debounce:5e3,msgID:"pollForSnapshot"}),rn.snapshot&&console.log(this.id,"Controller scheduling snapshot via reflector")}}}},{key:"preparePollForSnapshot",value:function(){var t=this.triggeringCpuTime||this.cpuTime;return this.triggeringCpuTime=null,this.cpuTime=0,!0===this.synced?{cpuTime:t}:null}},{key:"pollForSnapshot",value:function(t,e,n){n.cpuTime+=Math.random();var r=[this.id,"handleSnapshotVote","snapshotVote"];this.sendTutti(t,e,n,null,!0,r)}},{key:"handleSnapshotVote",value:function(t){var e=this;if(!0===this.synced){var n=t._local,r=t.tally,o=Object.keys(r);if(!n||!o.includes(n))return rn.snapshot&&console.log(this.id,"Snapshot: local vote not found"),void(this.cpuTime=0);var i=o.map((function(t){return JSON.parse(t)})),a={};i.forEach((function(t,e){var n=t.hash;a[n]||(a[n]=[]),a[n].push(e)}));var s=Object.keys(a),c=s[0];s.length>1&&(rn.snapshot&&console.log(this.id,"Snapshots fall into ".concat(s.length," groups")),s.sort((function(t,e){return a[e].length-a[t].length})),a[s[0]].length===a[s[1]].length&&(rn.snapshot&&console.log(this.id,"Deciding consensus by tie-break"),c=s[0]<s[1]?s[0]:s[1])),s.forEach((function(t){return function(t,r){var s=a[t];s.length>1&&s.sort((function(t,e){return i[t].cpuTime-i[e].cpuTime}));var c=s[0];o[c]===n&&e.serveSnapshot(r)}(t,t===c)}))}else rn.snapshot&&console.log("Ignoring snapshot vote during sync")}},{key:"serveSnapshot",value:function(t){var e=K.begin("snapshot"),n=this.takeSnapshot(),r=K.end("snapshot")-e;this.cpuTime-=r,rn.snapshot&&console.log(this.id,"Snapshotting took ".concat(Math.ceil(r)," ms")),this.uploadSnapshot(n,t)}},{key:"snapshotUrl",value:function(t,e,n,r,o){var i,a="".concat(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"code",e=I.has("dev","host","localhost"),n=e?"dev/".concat(kt("name","GUEST"),"/"):"";return"".concat(At(),"/").concat(n).concat(t,"/")}("snapshots")).concat(this.id),s=".json".concat(o?"."+o:""),c="".concat((i=Math.round(e),(""+i).padStart(10,"0")),"_").concat(n,"-").concat(t,"-").concat(r).concat(s);return"".concat(a,"/").concat(c)}},{key:"hashSnapshot",value:function(t){return t.meta.hash?t.meta.hash:(t.meta.hashPromise||(t.meta.hashPromise=new Promise((function(e){var n=Xe({},t);delete n.meta,$t(JSON.stringify(n)).then((function(n){t.meta.hash=n,delete t.meta.hashPromise,e(n)}))}))),t.meta.hashPromise)}},{key:"uploadSnapshot",value:(p=i(e.mark((function t(n){var r,o,i,a,s,c,u,l,h,f,d,v=arguments;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=!(v.length>1&&void 0!==v[1])||v[1],t.next=3,this.hashSnapshot(n);case 3:return o=Date.now(),i=JSON.stringify(n),a=Date.now()-o,s=n.meta,c=s.time,u=s.seq,l=s.hash,h=this.snapshotUrl("snap",c,u,l,"gz"),rn.snapshot&&console.log(this.id,"Controller uploading snapshot (".concat(i.length," bytes, ").concat(a,"ms) to ").concat(h)),f=this.connection.socket,t.next=12,this.uploadGzipped(h,i);case 12:if(d=t.sent,this.connection.socket===f){t.next=16;break}return console.error("Controller was reset while trying to upload snapshot"),t.abrupt("return",!1);case 16:if(d){t.next=19;break}return console.error("Failed to upload snapshot"),t.abrupt("return",!1);case 19:return r&&this.announceSnapshotUrl(c,u,l,h),t.abrupt("return",!0);case 21:case"end":return t.stop()}}),t,this)}))),function(t){return p.apply(this,arguments)})},{key:"announceSnapshotUrl",value:function(t,e,n,r){rn.snapshot&&console.log(this.id,"Controller sending snapshot url to reflector (time: ".concat(t,", seq: ").concat(e,", hash: ").concat(n,"): ").concat(r));try{this.connection.send(JSON.stringify({id:this.id,action:"SNAP",args:{time:t,seq:e,hash:n,url:r}}))}catch(t){console.error("ERROR while sending",t)}}},{key:"fetchJSON",value:(v=i(e.mark((function t(n,r){var o,i,a;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,fetch(n,{mode:"cors"});case 3:if(o=t.sent,!n.endsWith(".gz")){t.next=10;break}return t.next=7,o.arrayBuffer();case 7:return i=t.sent,a=Ze.inflate(new Uint8Array(i),{to:"string"}),t.abrupt("return",JSON.parse(a));case 10:return t.next=12,o.json();case 12:return t.abrupt("return",t.sent);case 15:t.prev=15,t.t0=t.catch(0);case 17:return t.abrupt("return",r);case 18:case"end":return t.stop()}}),t,null,[[0,15]])}))),function(t,e){return v.apply(this,arguments)})},{key:"uploadJSON",value:(d=i(e.mark((function t(n,r){var o,i;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,fetch(n,{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json"},body:r});case 3:return o=t.sent,i=o.ok,t.abrupt("return",i);case 8:t.prev=8,t.t0=t.catch(0);case 10:return t.abrupt("return",!1);case 11:case"end":return t.stop()}}),t,null,[[0,8]])}))),function(t,e){return d.apply(this,arguments)})},{key:"uploadGzipped",value:(f=i(e.mark((function t(n,r){var o,i,a,s,c;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return o=Date.now(),i=(new TextEncoder).encode(r),a=Ze.gzip(i,{level:1}),rn.snapshot&&console.log("Snapshot gzipping took ".concat(Date.now()-o,"ms")),t.prev=4,t.next=7,fetch(n,{method:"PUT",mode:"cors",headers:{"Content-Type":"application/octet-stream"},body:a});case 7:return s=t.sent,c=s.ok,t.abrupt("return",c);case 12:t.prev=12,t.t0=t.catch(4);case 14:return t.abrupt("return",!1);case 15:case"end":return t.stop()}}),t,null,[[4,12]])}))),function(t,e){return f.apply(this,arguments)})},{key:"convertReflectorMessage",value:function(t){var e=this.id,r="noop",o=[];switch(t[2].what){case"users":var i=t[2],a=i.joined,s=i.left,c=i.active,u=i.total;this.users=c,this.usersTotal=u;var l,h=this.id,f={entered:a||[],exited:s||[],count:c},d=Ke(f.entered);try{for(d.s();!(l=d.n()).done;){var v=l.value;v.length>2&&(v.length=2)}}catch(t){d.e(t)}finally{d.f()}e=this.id,r="publishFromModel",o=[h,"__users__",f],ae.handleEvent(this.viewId+":__users__",f);break;case"tally":var p=t[2],y=p.tuttiSeq,m=p.tally,g=p.tallyTarget,b={tuttiSeq:y,tally:m},w=this.tuttiHistory.find((function(t){return t.tuttiSeq===y}));w&&(b._local=w.payload);var k=n(g,3);e=k[0],r=k[1],o=[k[2],b]}var S=new _e(0,0,e,r,o);t[2]=S.asState()[2]}},{key:"receive",value:(c=i(e.mark((function t(n,r){var o,i,a,s,c,u,l,h,f,d,v,p,y=this;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.lastReceived=this.connection.lastReceived,t.t0=n,t.next="START"===t.t0?4:"SYNC"===t.t0?13:"RECV"===t.t0?33:"TICK"===t.t0?41:"LEAVE"===t.t0?48:51;break;case 4:return rn.session&&console.log(this.id,"Controller received START"),this.install(),o=this.takeSnapshot(),t.next=9,this.uploadSnapshot(o,!0);case 9:return i=t.sent,this.islandCreator.startedOrSynced.resolve(this.island),i?this.requestTicks():this.connection.closeConnectionWithError("start","failed to establish session"),t.abrupt("return");case 13:a=r.messages,s=r.url,c=r.time,rn.session&&console.log(this.id,"Controller received SYNC: time ".concat(c,", ").concat(a.length," messages, ").concat(s)),u=Ke(a);try{for(u.s();!(l=u.n()).done;)h=l.value,rn.messages&&console.log(this.id,"Controller received message in SYNC "+JSON.stringify(h)),h[1]>>>=0,"string"!=typeof h[2]&&this.convertReflectorMessage(h),this.networkQueue.put(h),this.timeFromReflector(h[0])}catch(t){u.e(t)}finally{u.f()}return this.timeFromReflector(c),rn.session&&console.log("".concat(this.id," fetching snapshot ").concat(s)),t.next=21,this.fetchJSON(s);case 21:if(f=t.sent,this.islandCreator.snapshot=f,this.connected){t.next=26;break}return console.log(this.id,"socket went away during SYNC"),t.abrupt("return");case 26:return this.install(),this.fastForwardTo=c,rn.session&&console.log("".concat(this.id," fast forwarding from ").concat(Math.round(this.island.time)," to ").concat(this.fastForwardTo)),this.getTickAndMultiplier(),d=function t(){y.simulate(Date.now()+200)?(rn.session&&console.log("".concat(y.id," fast forwarded to ").concat(Math.round(y.island.time))),y.fastForwardTo=-1,y.islandCreator.startedOrSynced.resolve(y.island)):setTimeout(t,0)},setTimeout(d,0),t.abrupt("return");case 33:return rn.messages&&console.log(this.id,"Controller received RECV "+JSON.stringify(r)),"string"!=typeof(v=r)[2]&&this.convertReflectorMessage(v),v[1]>>>=0,v[3]===this.viewId&&this.addToStatistics(v[4],this.lastReceived),this.networkQueue.put(v),this.timeFromReflector(v[0]),t.abrupt("return");case 41:if(this.island){t.next=43;break}return t.abrupt("return");case 43:return p="number"==typeof r?r:r.time,rn.ticks&&console.log(this.id,"Controller received TICK "+p),this.timeFromReflector(p),this.tickMultiplier&&this.multiplyTick(p),t.abrupt("return");case 48:return console.log(this.id,"Controller received LEAVE"),this.leave(),t.abrupt("return");case 51:console.warn("Unknown action:",n,r);case 52:case"end":return t.stop()}}),t,this)}))),function(t,e){return c.apply(this,arguments)})},{key:"install",value:function(){rn.session&&console.log("".concat(this.id," installing island"));var t=this.islandCreator,e=t.snapshot,n=t.init,r=t.options,o=new Se(e,(function(){try{return n(r)}catch(t){throw ct("init",t),t}}));if(rn.initsnapshot&&!e.modelsById){var i=JSON.stringify(o.snapshot());o=new Se(JSON.parse(i),(function(){return n(r)}))}var a=this.lastKnownTime(o);this.time=Math.max(this.time,a),this.setIsland(o)}},{key:"setIsland",value:function(t){this.island=t,this.island.controller=this}},{key:"createCleanIsland",value:function(){var t=this.islandCreator,e=t.options,n=t.init,r={id:this.id};return new Se(r,(function(){return n(e)}))}},{key:"join",value:(s=i(e.mark((function t(){var n,r,o,i;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.checkForConnection(!1),t.next=3,this.connection.connectionPromise;case 3:cn.add(this),rn.session&&console.log(this.id,"Controller sending JOIN"),n=this.user,r=n.name,o=n.id,i={name:this.islandCreator.name,options:this.islandCreator.options,version:1,user:[o,r],url:wt.sessionURL,codeHash:this.islandCreator.codeHash,sdk:tn},this.connection.send(JSON.stringify({id:this.id,action:"JOIN",args:i}));case 8:case"end":return t.stop()}}),t,this)}))),function(){return s.apply(this,arguments)})},{key:"startedOrSynced",value:(a=i(e.mark((function t(){var n=this;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,e){return n.islandCreator.startedOrSynced={resolve:t,reject:e}})));case 1:case"end":return t.stop()}}),t)}))),function(){return a.apply(this,arguments)})},{key:"leave",value:function(){this.connected&&(console.log(this.id,"Controller LEAVING session for ".concat(this.islandCreator.name)),this.connection.send(JSON.stringify({id:this.id,action:"LEAVING"}))),cn.delete(this);var t=this.islandCreator.destroyerFn;if(this.reset(),!this.islandCreator)throw Error("do not discard islandCreator!");t&&t()}},{key:"sendMessage",value:function(t){this.connected&&(this.viewOnly||(rn.sends&&console.log(this.id,"Controller sending SEND ".concat(t.asState())),this.lastSent=Date.now(),this.connection.send(JSON.stringify({id:this.id,action:"SEND",args:[].concat(r(t.asState()),[this.viewId,this.lastSent,this.latency])}))))}},{key:"sendTagged",value:function(t,e){this.connected&&(this.viewOnly||(rn.sends&&console.log(this.id,"Controller sending tagged SEND ".concat(t.asState()," with tags ").concat(JSON.stringify(e))),this.lastSent=Date.now(),this.connection.send(JSON.stringify({id:this.id,action:"SEND",args:[].concat(r(t.asState()),[this.viewId,this.lastSent]),tags:e}))))}},{key:"sendTutti",value:function(t,e,n,r,o,i){if(this.connected&&!this.viewOnly){var a=h(n);rn.sends&&console.log(this.id,"Controller sending TUTTI ".concat(a," ").concat(r&&r.asState()," ").concat(i)),this.tuttiHistory.push({tuttiSeq:e,payload:a}),this.tuttiHistory.length>100&&this.tuttiHistory.shift(),this.lastSent=Date.now(),this.connection.send(JSON.stringify({id:this.id,action:"TUTTI",args:[t,e,a,r&&r.asState(),o,i]}))}}},{key:"sendVote",value:function(t,e,n){var r=[this.island.id,"handleModelEventInView",this.island.id+":"+e];this.sendTutti(this.island.time,t,n,null,!0,r)}},{key:"addToStatistics",value:function(t,e){this.latency=e-t,this.latencyHistory&&(this.latencyHistory.length>=100&&this.latencyHistory.shift(),this.latencyHistory.push({time:e,ms:this.latency}))}},{key:"getTickAndMultiplier",value:function(){var t=this.islandCreator.options,e=((t.tps?t.tps:this.islandCreator.tps?this.islandCreator.tps:20)+"x").split("x").map((function(t){return Number.parseInt("0"+t,10)})),r=n(e,2),o=r[0],i=r[1],a=1e3/Math.max(1,Math.min(60,o)),s=Math.max(1,i);return s>1&&!on&&(this.tickMultiplier={tick:a,multiplier:s}),{tick:a,multiplier:s}}},{key:"requestTicks",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.connected&&this.island){var e=this.getTickAndMultiplier(),n=e.tick,r=e.multiplier;t.tick=n,t.delay=n*(r-1)/r,rn.session&&console.log(this.id,"Controller requesting TICKS",t);try{this.connection.send(JSON.stringify({id:this.id,action:"TICKS",args:t}))}catch(t){console.error("ERROR while sending",t)}}}},{key:"simulate",value:function(t){var e=this;if(!this.island)return!0;try{for(var n=K.begin("simulate"),r=!0;r;){var o=this.networkQueue.peek();if(!o)break;if(!(r=this.island.advanceTo(o[0],t)))break;if(this.fastForwardTo>=0&&o[0]>=this.fastForwardTo)return!0;this.networkQueue.nextNonBlocking();var i=this.island.scheduleExternalMessage(o);r=this.island.advanceTo(i.time,t),this.cpuTime+=5}if(this.fastForwardTo>=0)return!!r&&this.island.advanceTo(this.fastForwardTo,t);r&&(r=this.island.advanceTo(this.time,t)),this.cpuTime+=Math.max(.01,K.end("simulate")-n);var a=this.backlog;if(K.backlog(a),"boolean"==typeof this.synced&&(this.synced&&a>1e3||!this.synced&&a<100))!this.synced?this.syncTimer||(this.syncTimer=setTimeout((function(){delete e.syncTimer,e.backlog<100&&e.applySyncChange(!0)}),200)):this.applySyncChange(!1);return r&&this.cpuTime>5e3&&(this.triggeringCpuTime=this.cpuTime,this.cpuTime=0,setTimeout((function(){return e.scheduleSnapshot()}),Math.floor(2e3*Math.random()))),r}catch(t){return ct("simulate",t),this.connection.closeConnectionWithError("simulate",t),"error"}}},{key:"applySyncChange",value:function(t){this.synced=t,wt.showSyncWait(!t),this.island.publishFromView(this.viewId,"synced",t)}},{key:"inViewRealm",value:function(t){var e=this;return de(this.island,(function(){return t(e.island)}))}},{key:"processModelViewEvents",value:function(){return this.island?this.island.processModelViewEvents():0}},{key:"timeFromReflector",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"reflector";t<this.time?("controller"!==e||rn.ticks)&&console.warn("time is ".concat(this.time,", ignoring time ").concat(t," from ").concat(e)):("boolean"!=typeof this.synced&&(this.synced=!1),this.time=t,this.island&&K.backlog(this.backlog),this.tickHook&&this.tickHook())}},{key:"multiplyTick",value:function(t){var e=this;this.localTicker&&window.clearInterval(this.localTicker);var n=this.tickMultiplier,r=n.tick,o=n.multiplier,i=r/o,a=1;this.localTicker=window.setInterval((function(){e.timeFromReflector(t+a*i,"controller"),rn.ticks&&console.log(e.id,"Controller generate TICK "+e.time,a),++a>=o&&(window.clearInterval(e.localTicker),e.localTicker=0)}),i)}},{key:"id",get:function(){return this.island?this.island.id:this.islandCreator.snapshot.id}},{key:"user",get:function(){return{id:this.viewId,name:kt("name","GUEST")}}},{key:"viewOnly",get:function(){return this.islandCreator.viewOnly}},{key:"backlog",get:function(){return this.island?this.time-this.island.time:0}},{key:"starvation",get:function(){return Date.now()-this.lastReceived}},{key:"activity",get:function(){return Date.now()-this.lastSent}},{key:"connected",get:function(){return this.connection.connected}},{key:"latencies",get:function(){return this.latencyHistory||(this.latencyHistory=[]),this.latencyHistory}}]),t}(),ln=function(){function t(e){u(this,t),this.controller=e,this.connectBlocked=!1,this.connectRestricted=!1,this.connectHasBeenCalled=!1,this.setUpConnectionPromise()}var n;return l(t,[{key:"setUpConnectionPromise",value:function(){var t=this;this.connectionPromise=new Promise((function(e){return t.resolveConnection=e}))}},{key:"checkForConnection",value:function(t){this.socket||this.connectHasBeenCalled||this.connectBlocked||this.connectRestricted&&!t||this.connectToReflector()}},{key:"connectToReflector",value:(n=i(e.mark((function t(){var n,r=this;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.connectHasBeenCalled=!0,this.connectBlocked=!1,this.connectRestricted=!1,(n=I.reflector||(rn.reflector?"wss://croquet.io/reflector-dev/dev":nn)).match(/^wss?:/)){t.next=6;break}throw Error("Cannot interpret reflector address "+n);case 6:return n.endsWith("/")||(n+="/"),t.abrupt("return",new Promise((function(t){var e=Object.assign(new WebSocket("".concat(n).concat(r.controller.id)),{onopen:function(n){r.socket=e,(rn.session||rn.reflector)&&console.log(r.socket.constructor.name,"connected to",r.socket.url),K.connected(!0),r.resolveConnection(null),t()},onmessage:function(t){r.receive(t.data)},onerror:function(t){it("Connection error"),console.log(e.constructor.name,"error")},onclose:function(t){var n=1e3!==t.code&&t.code<4100,o=4110===t.code;o||it("Connection closed: ".concat(t.code," ").concat(t.reason),{duration:n?void 0:36e5}),rn.session&&console.log(e.constructor.name,"closed:",t.code,t.reason),K.connected(!1),o?r.connectRestricted=!0:r.connectBlocked=!0,r.disconnected(),n&&(at("Reconnecting ..."),window.setTimeout((function(){return r.connectToReflector()}),2e3))}})})));case 8:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"disconnected",value:function(){this.socket&&(this.socket=null,this.lastReceived=0,this.lastSent=0,this.connectHasBeenCalled=!1,this.setUpConnectionPromise(),this.controller.leave())}},{key:"send",value:function(t){this.lastSent=Date.now(),this.socket.send(t)}},{key:"receive",value:function(t){this.lastReceived=Date.now();var e=JSON.parse(t),n=e.id,r=e.action,o=e.args;if(n)try{this.controller.receive(r,o)}catch(t){this.closeConnectionWithError("receive",t)}else switch(r){case"PONG":rn.pong&&console.log("PONG after",Date.now()-o,"ms");break;default:console.warn("Unknown action",r)}}},{key:"dormantDisconnect",value:function(){this.connected&&(console.log("dormant; disconnecting from reflector"),this.socket.close(4110,"Going dormant"))}},{key:"closeConnectionWithError",value:function(t,e){console.error(e),console.warn("closing socket"),this.socket.close(4e3,"Error in "+t)}},{key:"PING",value:function(){this.connected&&(this.socket.bufferedAmount?console.log("Reflector connection stalled: ".concat(this.socket.bufferedAmount," bytes unsent")):this.send(JSON.stringify({action:"PING",args:Date.now()})))}},{key:"PULSE",value:function(){this.connected&&(this.socket.bufferedAmount&&console.log("Reflector connection stalled: ".concat(this.socket.bufferedAmount," bytes unsent")),this.send(JSON.stringify({action:"PULSE"})))}},{key:"keepAlive",value:function(){0!==this.lastReceived&&(Date.now()-this.lastReceived>100?this.PING():Date.now()-this.lastSent>2e4&&this.PULSE())}},{key:"connected",get:function(){return this.socket&&this.socket.readyState===WebSocket.OPEN}}]),t}();function hn(){return(hn=i(e.mark((function t(o){var a,s,c,u,l,h,f,d,v,p,y,m,g,b,w,k,S,x,C,E,O,_,T,A=arguments;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(T=function(){setInterval((function(){if("hidden"===document.visibilityState)if(!1===I.autoSleep)pn(performance.now(),p,S.view);else{var t=Date.now();f?t-f>1e4&&p.dormantDisconnect():f=t}else f=null}),1e3)},_=function(t){return{modelRoot:a.create(t,"modelRoot")}},O=function(){S.model=null,S.view&&(I.has("debug","session",!1)&&console.log(S.id,"Detaching root view"),S.view.detach(),""!==S.view.id&&console.warn("".concat(S.view," did not call super.detach()")),S.view=null),wt.clearSessionMoniker()},E=function(){return(E=i(e.mark((function t(r){var i,a,u,l,h,f;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(O(),i={snapshot:r,init:_,destroyerFn:C,options:y},a=0,u=Object.entries(c);a<u.length;a++)l=n(u[a],2),h=l[0],f=l[1],v.includes(h)&&(i[h]=f);return t.next=5,p.establishSession(o,i);case 5:S.model=t.sent.modelRoot,S.id=p.id,wt.makeSessionWidgets(S.id),p.inViewRealm((function(){I.has("debug","session",!1)&&console.log(S.id,"Creating root view"),S.view=new s(S.model)}));case 9:case"end":return t.stop()}}),t)})))).apply(this,arguments)},C=function(t){return E.apply(this,arguments)},u=function(t,e){return t===e||t.prototype instanceof e},a=A.length>1&&void 0!==A[1]?A[1]:Fe,s=A.length>2&&void 0!==A[2]?A[2]:Ge,c=A.length>3?A[3]:void 0,"string"!=typeof o?o=JSON.stringify(o)||"undefined":o||(o="unnamed"),u(a,Fe)){t.next=12;break}throw Error("ModelRoot must inherit from Croquet.Model");case 12:if(u(s,Ge)){t.next=19;break}if(!s||Object.getPrototypeOf(s)!==Object.prototype||void 0!==c){t.next=18;break}c=s,s=Ge,t.next=19;break;case 18:throw Error("ViewRoot must inherit from Croquet.View");case 19:c||(c={}),(l=I.reflector||c.reflector)&&(l.includes("://")?I.reflector=l:console.warn('Not a valid websocket url, ignoring reflector "'.concat(l,'"'))),c.debug&&(h=function(t){return"string"==typeof t&&(t=t.split(",")),t?Array.isArray(t)?t:[t]:[]},I.debug=[].concat(r(h(c.debug)),r(h(I.debug))).join(",")),f=null,"autoSleep"in c&&(I.autoSleep=c.autoSleep),T(),"expectedSimFPS"in c&&(vn=Math.min(c.expectedSimFPS,dn)),d=["tps"],v=["optionsFromUrl","login","autoSession"],mn(),p=new un,y={},c.options&&Object.assign(y,JSON.parse(JSON.stringify(c.options)));for(m=0,g=Object.entries(c);m<g.length;m++)b=n(g[m],2),w=b[0],k=b[1],d.includes(w)&&(y[w]=k);return t.t0=function(t){"hidden"!==document.visibilityState&&(f=null,pn(t,p,S.view))},S={id:"",model:null,view:null,step:t.t0,get latency(){return p.latency},get latencies(){return p.latencies}},t.next=38,C();case 38:return"manual"!==c.step&&(x=function t(e){S.step(e),window.requestAnimationFrame(t)},window.requestAnimationFrame(x)),t.abrupt("return",S);case 40:case"end":return t.stop()}}),t)})))).apply(this,arguments)}window.setInterval((function(){var t,e=Ke(cn);try{for(e.s();!(t=e.n()).done;){var n=t.value;n.connected&&n.connection.keepAlive()}}catch(t){e.e(t)}finally{e.f()}}),100);var fn=[0],dn=120,vn=60;function pn(t,e,n){e.checkForConnection(!0);var r=e.backlog,o=e.latency,i=e.starvation,a=e.activity;if(K.animationFrame(t,{backlog:r,starvation:i,latency:o,activity:a,users:e.users}),e.island){var s=Date.now(),c=fn.reduce((function(t,e){return t+e}),0)/fn.length;e.simulate(s+Math.min(c,200));var u=0===vn?0:1e3/vn*4;e.backlog>u&&e.simulate(s+200-c),fn.push(Date.now()-s),fn.length>4&&fn.shift(),K.begin("update"),e.processModelViewEvents(),K.end("update"),n&&(K.begin("render"),e.inViewRealm((function(){return n.update(t)})),K.end("render"))}}var yn={};function mn(){Object.isFrozen(yn)||(function t(e){if(!Object.isFrozen(e)){Object.freeze(e);for(var n=0,r=Object.values(e);n<r.length;n++){var i=r[n];!i||"object"!==o(i)&&"function"!=typeof i||t(i)}}}(yn),function(t){var e=JSON.stringify(t,(function(t,e){return"function"==typeof e?""+e:e}));if("{}"!==e){var n=JSON.parse(e),r=$t(h(n));r.then((function(t){console.log("hashing Croquet.Constants(".concat(Object.keys(n).join(", "),"): ").concat(t)),Lt()&&(Bt[t].name="Croquet Constants")})),Gt.push(r)}}(yn))}exports.App=wt,exports.Constants=yn,exports.Model=Fe,exports.View=Ge,exports.addClassHash=Kt,exports.gatherInternalClassTypes=function(t,e){var n={};return function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Set,a=Object.values(e).filter((function(t){var e=Object.prototype.toString.call(t).slice(8,-1);return("Object"===e||"Array"===e)&&!i.has(t)})),s=ye(a);try{for(s.s();!(n=s.n()).done;){var c=n.value;i.add(c);var u=r+"."+c.constructor.name;if(o[u]){if(o[u]!==c.constructor)throw new Error("Class with name "+u+" already gathered, but new one has different identity")}else o[u]=c.constructor}}catch(t){s.e(t)}finally{s.f()}var l,h=ye(a);try{for(h.s();!(l=h.n()).done;){var f=l.value;t(f,r,o,i)}}catch(t){h.e(t)}finally{h.f()}}({root:t},e,n,new Set),n},exports.startSession=function(t){return hn.apply(this,arguments)};
